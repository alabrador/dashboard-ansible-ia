module.exports=[57328,(e,t,s)=>{t.exports=e.x("node:assert",()=>require("node:assert"))},61095,(e,t,s)=>{t.exports=e.x("node:net",()=>require("node:net"))},85560,(e,t,s)=>{t.exports=e.x("node:tls",()=>require("node:tls"))},87769,(e,t,s)=>{t.exports=e.x("node:events",()=>require("node:events"))},50514,e=>{"use strict";var t,s=e.i(57328),r=e.i(12057),i=e.i(66680),n=e.i(61095),a=e.i(85560),o=e.i(87769);class c extends Error{constructor(e){super(e),this.name="InvalidAsn1Error"}}class h{size;currentLength=0;currentOffset=0;buffer;constructor(e){if(!Buffer.isBuffer(e))throw TypeError("data must be a Buffer");this.buffer=e,this.size=e.length}get length(){return this.currentLength}get offset(){return this.currentOffset}set offset(e){this.currentOffset=e}get remain(){return this.size-this.currentOffset}get remainingBuffer(){return this.buffer.subarray(this.currentOffset)}setBufferSize(e){this.size=e}readByte(e=!1){if(this.size-this.currentOffset<1)return null;let t=this.buffer.readUInt8(this.currentOffset);return e||(this.currentOffset+=1),t}peek(){return this.readByte(!0)}readLength(e){let t=e??this.currentOffset;if(t>=this.size)return null;let s=this.buffer.readUInt8(t);if(t+=1,(128&s)==128){let e=127&s;if(0===e)throw new c("Indefinite length not supported");if(e>4)throw new c("Encoding too long");if(this.size-t<e)return null;this.currentLength=0;for(let s=0;s<e;s++)this.currentLength=(this.currentLength<<8)+this.buffer.readUInt8(t),t+=1}else this.currentLength=s;return t}readSequence(e){let t=this.peek();if(null===t)return null;if(void 0!==e&&e!==t)throw new c(`Expected 0x${e.toString(16)}: got 0x${t.toString(16)}`);let s=this.readLength(this.currentOffset+1);return null===s?null:(this.currentOffset=s,t)}readInt(){return this.readTag(2)}readBoolean(){let e=this.readTag(1);return null===e?null:0!==e}readEnumeration(){return this.readTag(10)}readString(e=4,t=!1){let s=this.peek();if(null===s)return null;if(s!==e)throw new c(`Expected 0x${e.toString(16)}: got 0x${s.toString(16)}`);let r=this.readLength(this.currentOffset+1);if(null===r||this.currentLength>this.size-r)return null;if(this.currentOffset=r,0===this.currentLength)return t?Buffer.alloc(0):"";let i=this.buffer.subarray(this.currentOffset,this.currentOffset+this.currentLength);return this.currentOffset+=this.currentLength,t?i:i.toString("utf8")}readOID(e=6){let t=this.readString(e,!0);if(null===t)return null;let s=[],r=0;for(let e of t)r=(r<<7)+(127&e),(128&e)==0&&(s.push(r),r=0);let i=s[0]??0;return[Math.trunc(i/40),i%40,...s.slice(1)].join(".")}readTag(e){let t=this.peek();if(null===t)return null;if(t!==e)throw new c(`Expected 0x${e.toString(16)}: got 0x${t.toString(16)}`);let s=this.readLength(this.currentOffset+1);if(null===s)return null;if(this.currentLength>4)throw new c(`Integer too long: ${this.currentLength}`);if(this.currentLength>this.size-s)return null;this.currentOffset=s;let r=this.buffer.readUInt8(this.currentOffset),i=0;for(let e=0;e<this.currentLength;e++)i=i<<8|this.buffer.readUInt8(this.currentOffset),this.currentOffset+=1;return(128&r)==128&&this.currentLength<4&&(i-=1<<8*this.currentLength),0|i}}class u{data;size;currentOffset=0;growthFactor;sequenceOffsets=[];constructor(e={}){const t=e.size??1024;this.growthFactor=e.growthFactor??8,this.data=Buffer.alloc(t),this.size=t}get buffer(){if(this.sequenceOffsets.length>0)throw new c(`${this.sequenceOffsets.length} unended sequence(s)`);return this.data.subarray(0,this.currentOffset)}writeByte(e){this.ensureCapacity(1),this.data[this.currentOffset++]=e}writeInt(e,t=2){let s=e,r=4;for(;((0xff800000&s)==0||(0xff800000&s)==-8388608)&&r>1;)r--,s<<=8;if(r>4)throw new c("BER integers cannot be > 0xffffffff");for(this.ensureCapacity(2+r),this.data[this.currentOffset++]=t,this.data[this.currentOffset++]=r;r>0;)r--,this.data[this.currentOffset++]=(0xff000000&s)>>>24,s<<=8}writeNull(){this.writeByte(5),this.writeByte(0)}writeEnumeration(e,t=10){this.writeInt(e,t)}writeBoolean(e,t=1){this.ensureCapacity(3),this.data[this.currentOffset++]=t,this.data[this.currentOffset++]=1,this.data[this.currentOffset++]=255*!!e}writeString(e,t=4){let s=Buffer.byteLength(e);this.writeByte(t),this.writeLength(s),s>0&&(this.ensureCapacity(s),this.data.write(e,this.currentOffset),this.currentOffset+=s)}writeBuffer(e,t){this.writeByte(t),this.writeLength(e.length),this.ensureCapacity(e.length),e.copy(this.data,this.currentOffset,0,e.length),this.currentOffset+=e.length}writeStringArray(e){for(let t of e)this.writeString(t)}writeOID(e,t=6){if(!/^(\d+\.){3,}\d+$/.test(e))throw Error("Argument is not a valid OID string");let s=e.split("."),r=[],i=s[0]??"0",n=s[1]??"0";for(let e of(r.push(40*Number(i)+Number(n)),s.slice(2)))this.encodeOidOctet(r,Number(e));for(let e of(this.ensureCapacity(2+r.length),this.writeByte(t),this.writeLength(r.length),r))this.writeByte(e)}writeLength(e){if(this.ensureCapacity(4),e<=127)this.data[this.currentOffset++]=e;else if(e<=255)this.data[this.currentOffset++]=129,this.data[this.currentOffset++]=e;else if(e<=65535)this.data[this.currentOffset++]=130,this.data[this.currentOffset++]=e>>8,this.data[this.currentOffset++]=e;else if(e<=0xffffff)this.data[this.currentOffset++]=131,this.data[this.currentOffset++]=e>>16,this.data[this.currentOffset++]=e>>8,this.data[this.currentOffset++]=e;else throw new c("Length too long (> 4 bytes)")}startSequence(e=48){this.writeByte(e),this.sequenceOffsets.push(this.currentOffset),this.ensureCapacity(3),this.currentOffset+=3}endSequence(){let e=this.sequenceOffsets.pop();if(void 0===e)throw new c("No sequence to end");let t=e+3,s=this.currentOffset-t;if(s<=127)this.shiftContent(t,s,-2),this.data[e]=s;else if(s<=255)this.shiftContent(t,s,-1),this.data[e]=129,this.data[e+1]=s;else if(s<=65535)this.data[e]=130,this.data[e+1]=s>>8,this.data[e+2]=s;else if(s<=0xffffff)this.shiftContent(t,s,1),this.data[e]=131,this.data[e+1]=s>>16,this.data[e+2]=s>>8,this.data[e+3]=s;else throw new c("Sequence too long")}encodeOidOctet(e,t){t<128?e.push(t):(t<16384?e.push(t>>>7|128):(t<2097152?e.push(t>>>14|128):(t<0x10000000?e.push(t>>>21|128):(e.push((t>>>28|128)&255),e.push((t>>>21|128)&255)),e.push((t>>>14|128)&255)),e.push((t>>>7|128)&255)),e.push(127&t))}shiftContent(e,t,s){this.data.copy(this.data,e+s,e,e+t),this.currentOffset+=s}ensureCapacity(e){if(this.size-this.currentOffset<e){let t=this.size*this.growthFactor;t-this.currentOffset<e&&(t+=e);let s=Buffer.alloc(t);this.data.copy(s,0,0,this.currentOffset),this.data=s,this.size=t}}}class l{type;critical;constructor(e,t={}){this.type=e,this.critical=!0===t.critical}write(e){e.startSequence(),e.writeString(this.type),e.writeBoolean(this.critical),this.writeControl(e),e.endSequence()}parse(e){this.parseControl(e)}writeControl(e){}parseControl(e){}}class d extends l{static type="2.16.840.1.113730.3.4.7";value;constructor(e={}){super(d.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t,s=e.readInt()??0;8===s&&(t=e.readString());let r=e.readInt()??0;this.value={changeType:s,previousDN:t,changeNumber:r}}}writeControl(e){if(!this.value)return;let t=new u;t.startSequence(),t.writeInt(this.value.changeType),this.value.previousDN&&t.writeString(this.value.previousDN),t.writeInt(this.value.changeNumber),t.endSequence(),e.writeBuffer(t.buffer,4)}}class f extends l{static type="1.2.840.113556.1.4.319";value;constructor(e={}){super(f.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t=e.readInt()??0,s=e.readString(4,!0)??Buffer.alloc(0);this.value={size:t,cookie:s}}}writeControl(e){if(!this.value)return;let t=new u;t.startSequence(),t.writeInt(this.value.size),this.value.cookie?.length?t.writeBuffer(this.value.cookie,4):t.writeString(""),t.endSequence(),e.writeBuffer(t.buffer,4)}}class p extends l{static type="2.16.840.1.113730.3.4.3";value;constructor(e={}){super(p.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t=e.readInt()??0,s=e.readBoolean()??!1,r=e.readBoolean()??!1;this.value={changeTypes:t,changesOnly:s,returnECs:r}}}writeControl(e){if(!this.value)return;let t=new u;t.startSequence(),t.writeInt(this.value.changeTypes),t.writeBoolean(this.value.changesOnly),t.writeBoolean(this.value.returnECs),t.endSequence(),e.writeBuffer(t.buffer,4)}}class g extends l{static type="1.2.840.113556.1.4.473";values;constructor(e={}){super(g.type,e),Array.isArray(e.value)?this.values=e.value:"object"==typeof e.value?this.values=[e.value]:this.values=[]}parseControl(e){if(e.readSequence(48))for(;e.readSequence(48);){let t=e.readString()??"",s="",r=!1;128===e.peek()&&(s=e.readString(128)??""),129===e.peek()&&(r=0!==e.readTag(129)),this.values.push({attributeType:t,orderingRule:s,reverseOrder:r})}}writeControl(e){if(!this.values.length)return;let t=new u;for(let e of(t.startSequence(48),this.values))t.startSequence(48),t.writeString(e.attributeType,4),e.orderingRule&&t.writeString(e.orderingRule,128),void 0!==e.reverseOrder&&t.writeBoolean(e.reverseOrder,129),t.endSequence();t.endSequence(),e.writeBuffer(t.buffer,4)}}class w extends Error{messageDetails;constructor(e){super(e),this.name="MessageParserError",Object.setPrototypeOf(this,w.prototype)}}class m extends Error{code;constructor(e,t){super(`${t} Code: 0x${e.toString(16)}`),this.name="ResultCodeError",this.code=e,Object.setPrototypeOf(this,m.prototype)}}class b extends m{constructor(e){super(11,e??"An LDAP server limit set by an administrative authority has been exceeded."),this.name="AdminLimitExceededError",Object.setPrototypeOf(this,b.prototype)}}class y extends m{constructor(e){super(71,e??"The modify DN operation moves the entry from one LDAP server to another and thus requires more than one LDAP server."),this.name="AffectsMultipleDSAsError",Object.setPrototypeOf(this,y.prototype)}}class S extends m{constructor(e){super(36,e??"Either the client does not have access rights to read the aliased object's name or dereferencing is not allowed."),this.name="AliasDerefProblemError",Object.setPrototypeOf(this,S.prototype)}}class O extends m{constructor(e){super(33,e??"An error occurred when an alias was dereferenced."),this.name="AliasProblemError",Object.setPrototypeOf(this,O.prototype)}}class v extends m{constructor(e){super(68,e??"The add operation attempted to add an entry that already exists, or that the modify operation attempted to rename an entry to the name of an entry that already exists."),this.name="AlreadyExistsError",Object.setPrototypeOf(this,v.prototype)}}class x extends m{constructor(e){super(7,e??"The Directory Server does not support the requested Authentication Method."),this.name="AuthMethodNotSupportedError",Object.setPrototypeOf(this,x.prototype)}}class k extends m{constructor(e){super(51,e??"The LDAP server is too busy to process the client request at this time."),this.name="BusyError",Object.setPrototypeOf(this,k.prototype)}}class E extends m{constructor(e){super(13,e??"The session is not protected by a protocol such as Transport Layer Security (TLS), which provides session confidentiality and the request will not be handled without confidentiality enabled."),this.name="ConfidentialityRequiredError",Object.setPrototypeOf(this,E.prototype)}}class L extends m{constructor(e){super(19,e??"The attribute value specified in a Add Request, Modify Request or ModifyDNRequest operation violates constraints placed on the attribute. The constraint can be one of size or content (string only, no binary)."),this.name="ConstraintViolationError",Object.setPrototypeOf(this,L.prototype)}}class A extends m{constructor(e){super(48,e??"The client is attempting to use an authentication method incorrectly."),this.name="InappropriateAuthError",Object.setPrototypeOf(this,A.prototype)}}class M extends m{constructor(e){super(18,e??"The matching rule specified in the search filter does not match a rule defined for the attribute's syntax."),this.name="InappropriateMatchingError",Object.setPrototypeOf(this,M.prototype)}}class I extends m{constructor(e){super(50,e??"The caller does not have sufficient rights to perform the requested operation."),this.name="InsufficientAccessError",Object.setPrototypeOf(this,I.prototype)}}class q extends m{constructor(e){super(49,e??"Invalid credentials during a bind operation."),this.name="InvalidCredentialsError",Object.setPrototypeOf(this,q.prototype)}}class B extends m{constructor(e){super(34,e??"The syntax of the DN is incorrect."),this.name="InvalidDNSyntaxError",Object.setPrototypeOf(this,B.prototype)}}class D extends m{constructor(e){super(21,e??"The attribute value specified in an Add Request, Compare Request, or Modify Request operation is an unrecognized or invalid syntax for the attribute."),this.name="InvalidSyntaxError",Object.setPrototypeOf(this,D.prototype)}}class C extends m{constructor(e){super(35,e??"The specified operation cannot be performed on a leaf entry."),this.name="IsLeafError",Object.setPrototypeOf(this,C.prototype)}}class _ extends m{constructor(e){super(54,e??"The client discovered an alias or LDAP Referral loop, and is thus unable to complete this request."),this.name="LoopDetectError",Object.setPrototypeOf(this,_.prototype)}}class P extends m{constructor(e){super(95,e),this.name="MoreResultsToReturnError",Object.setPrototypeOf(this,P.prototype)}}class T extends m{constructor(e){super(64,e??"The Add Request or Modify DN Request operation violates the schema's structure rules."),this.name="NamingViolationError",Object.setPrototypeOf(this,T.prototype)}}class $ extends m{constructor(e){super(69,e??"The modify operation attempted to modify the structure rules of an object class."),this.name="NoObjectClassModsError",Object.setPrototypeOf(this,$.prototype)}}class j extends m{constructor(e){super(16,e??"The attribute specified in the Modify Request or Compare Request operation does not exist in the entry."),this.name="NoSuchAttributeError",Object.setPrototypeOf(this,j.prototype)}}class R extends m{constructor(e){super(32,e??"The target object cannot be found."),this.name="NoSuchObjectError",Object.setPrototypeOf(this,R.prototype)}}class N extends m{constructor(e){super(66,e??"The requested operation is permitted only on leaf entries."),this.name="NotAllowedOnNonLeafError",Object.setPrototypeOf(this,N.prototype)}}class z extends m{constructor(e){super(67,e??"The modify operation attempted to remove an attribute value that forms the entry's relative distinguished name."),this.name="NotAllowedOnRDNError",Object.setPrototypeOf(this,z.prototype)}}class F extends m{constructor(e){super(248,e??"No result message for the request."),this.name="NoResultError",Object.setPrototypeOf(this,F.prototype)}}class U extends m{constructor(e){super(65,e??"The Add Request, Modify Request, or modify DN operation violates the object class rules for the entry."),this.name="ObjectClassViolationError",Object.setPrototypeOf(this,U.prototype)}}class V extends m{constructor(e){super(1,e??"Request was out of sequence with another operation in progress."),this.name="OperationsError",Object.setPrototypeOf(this,V.prototype)}}class H extends m{constructor(e){super(2,e??"Client sent data to the server that did not comprise a valid LDAP request."),this.name="ProtocolError",Object.setPrototypeOf(this,H.prototype)}}class W extends m{constructor(e){super(70,e??"Results are too large."),this.name="ResultsTooLargeError",Object.setPrototypeOf(this,W.prototype)}}class J extends m{response;constructor(e){super(14,e.errorMessage||"The server is ready for the next step in the SASL authentication process. The client must send the server the same SASL Mechanism to continue the process."),this.response=e,this.name="SaslBindInProgressError",Object.setPrototypeOf(this,J.prototype)}}class G extends m{constructor(e){super(4,e??"There were more entries matching the criteria contained in a SearchRequest operation than were allowed to be returned by the size limit configuration."),this.name="SizeLimitExceededError",Object.setPrototypeOf(this,G.prototype)}}class X extends m{constructor(e){super(8,e??"Client requested an operation that requires strong authentication."),this.name="StrongAuthRequiredError",Object.setPrototypeOf(this,X.prototype)}}class K extends m{constructor(e){super(3,e??"Processing on the associated request Timeout limit specified by either the client request or the server administration limits has been exceeded and has been terminated because it took too long to complete."),this.name="TimeLimitExceededError",Object.setPrototypeOf(this,K.prototype)}}class Q extends m{constructor(e){super(112,e??"TLS is not supported on the server."),this.name="TLSNotSupportedError",Object.setPrototypeOf(this,Q.prototype)}}class Y extends m{constructor(e){super(20,e??"The attribute value specified in a Add Request or Modify Request operation already exists as a value for that attribute."),this.name="TypeOrValueExistsError",Object.setPrototypeOf(this,Y.prototype)}}class Z extends m{constructor(e){super(12,e??"One or more critical extensions were not available by the LDAP server. Either the server does not support the control or the control is not appropriate for the operation type."),this.name="UnavailableCriticalExtensionError",Object.setPrototypeOf(this,Z.prototype)}}class ee extends m{constructor(e){super(52,e??"The LDAP server cannot process the client's bind request."),this.name="UnavailableError",Object.setPrototypeOf(this,ee.prototype)}}class et extends m{constructor(e){super(17,e??"The attribute specified in the modify or add operation does not exist in the LDAP server's schema."),this.name="UndefinedTypeError",Object.setPrototypeOf(this,et.prototype)}}class es extends m{constructor(e,t){super(e,t??"Unknown error."),this.name="UnknownStatusCodeError",Object.setPrototypeOf(this,es.prototype)}}class er extends m{constructor(e){super(53,e??"The LDAP server cannot process the request because of server-defined restrictions."),this.name="UnwillingToPerformError",Object.setPrototypeOf(this,er.prototype)}}class ei{write(e){e.startSequence(this.type),this.writeFilter(e),e.endSequence()}parse(e){this.parseFilter(e)}matches(e={},t){return!0}escape(e){let t="";if(Buffer.isBuffer(e))for(let s of e)s<16?t+=`\\0${s.toString(16)}`:t+=`\\${s.toString(16)}`;else for(let s of e)switch(s){case"*":t+="\\2a";break;case"(":t+="\\28";break;case")":t+="\\29";break;case"\\":t+="\\5c";break;case"\0":t+="\\00";break;default:t+=s}return t}parseFilter(e){}writeFilter(e){}getObjectValue(e,t,s){let r;if(void 0!==e[t])r=t;else if(!s&&"objectclass"===t.toLowerCase()){for(let s of Object.keys(e))if(s.toLowerCase()===t.toLowerCase()){r=s;break}}if(r)return e[r]}}class en extends ei{type=160;filters;constructor(e){super(),this.filters=e.filters}writeFilter(e){for(let t of this.filters)t.write(e)}matches(e={},t){if(!this.filters.length)return!0;for(let s of this.filters)if(!s.matches(e,t))return!1;return!0}toString(){let e="(&";for(let t of this.filters)e+=t.toString();return e+")"}}class ea extends ei{type=168;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){throw Error("Approximate match implementation unknown")}toString(){return`(${this.escape(this.attribute)}~=${this.escape(this.value)})`}}class eo extends ei{type=163;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??"","objectclass"===this.attribute&&(this.value=this.value.toLowerCase())}writeFilter(e){e.writeString(this.attribute),Buffer.isBuffer(this.value)?e.writeBuffer(this.value,4):e.writeString(this.value)}matches(e={},t){let s=this.getObjectValue(e,this.attribute,t);if(void 0!==s){if(Buffer.isBuffer(this.value)&&Buffer.isBuffer(s))return this.value===s;let e=Buffer.isBuffer(this.value)?this.value.toString("utf8"):this.value;return t?e===s:e.toLowerCase()===s.toLowerCase()}return!1}toString(){return`(${this.escape(this.attribute)}=${this.escape(this.value)})`}}class ec extends ei{type=169;value;rule;matchType;dnAttributes;constructor(e={}){super(),this.matchType=e.matchType??"",this.rule=e.rule??"",this.dnAttributes=!0===e.dnAttributes,this.value=e.value??""}parseFilter(e){let t=e.offset+e.length;for(;e.offset<t;){let t=e.peek();switch(t){case 129:this.rule=e.readString(t)??"";break;case 130:this.matchType=e.readString(t)??"";break;case 131:this.value=e.readString(t)??"";break;case 132:this.dnAttributes=e.readBoolean()??!1;break;default:{let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Invalid ext_match filter type: ${e}`)}}}}writeFilter(e){this.rule&&e.writeString(this.rule,129),this.matchType&&e.writeString(this.matchType,130),e.writeString(this.value,131),this.dnAttributes&&e.writeBoolean(this.dnAttributes,132)}matches(e={},t){throw Error("Approximate match implementation unknown")}toString(){let e=`(${this.escape(this.matchType)}:`;return this.dnAttributes&&(e+="dn:"),this.rule&&(e+=`${this.escape(this.rule)}:`),e+=`=${this.escape(this.value)})`}}class eh extends ei{type=165;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){let s=this.getObjectValue(e,this.attribute,t);return void 0!==s&&(t?s>=this.value:s.toLowerCase()>=this.value.toLowerCase())}toString(){return`(${this.escape(this.attribute)}>=${this.escape(this.value)})`}}class eu extends ei{type=166;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){let s=this.getObjectValue(e,this.attribute,t);return void 0!==s&&(t?s<=this.value:s.toLowerCase()<=this.value.toLowerCase())}toString(){return`(${this.escape(this.attribute)}<=${this.escape(this.value)})`}}class el extends ei{type=162;filter;constructor(e){super(),this.filter=e.filter}writeFilter(e){this.filter.write(e)}matches(e={},t){return!this.filter.matches(e,t)}toString(){return`(!${this.filter.toString()})`}}class ed extends ei{type=161;filters;constructor(e){super(),this.filters=e.filters}writeFilter(e){for(let t of this.filters)t.write(e)}matches(e={},t){if(!this.filters.length)return!0;for(let s of this.filters)if(s.matches(e,t))return!0;return!1}toString(){let e="(|";for(let t of this.filters)e+=t.toString();return e+")"}}class ef extends ei{type=135;attribute;constructor(e={}){super(),this.attribute=e.attribute??""}parseFilter(e){this.attribute=e.buffer.subarray(0,e.length).toString("utf8").toLowerCase(),e.offset+=e.length}writeFilter(e){for(let t=0;t<this.attribute.length;t+=1)e.writeByte(this.attribute.charCodeAt(t))}matches(e={},t){return void 0!==this.getObjectValue(e,this.attribute,t)}toString(){return`(${this.escape(this.attribute)}=*)`}}class ep extends ei{type=164;attribute;initial;any;final;constructor(e={}){super(),this.attribute=e.attribute??"",this.initial=e.initial??"",this.any=e.any??[],this.final=e.final??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=e.peek();switch(t){case 128:this.initial=e.readString(t)??"","objectclass"===this.attribute&&(this.initial=this.initial.toLowerCase());break;case 129:{let s=e.readString(t)??"";"objectclass"===this.attribute&&(s=s.toLowerCase()),this.any.push(s);break}case 130:this.final=e.readString(t)??"","objectclass"===this.attribute&&(this.final=this.final.toLowerCase());break;default:{let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Invalid substring filter type: ${e}`)}}}}writeFilter(e){for(let t of(e.writeString(this.attribute),e.startSequence(),this.initial&&e.writeString(this.initial,128),this.any))e.writeString(t,129);this.final&&e.writeString(this.final,130),e.endSequence()}matches(e={},t){let s=this.getObjectValue(e,this.attribute,t);if(void 0!==s){let e="";for(let t of(this.initial&&(e+=`^${ep._escapeRegExp(this.initial)}.*`),this.any))e+=`${ep._escapeRegExp(t)}.*`;return this.final&&(e+=`${ep._escapeRegExp(this.final)}$`),new RegExp(e,t?"gmu":"igmu").test(s)}return!1}toString(){let e=`(${this.escape(this.attribute)}=${this.escape(this.initial)}*`;for(let t of this.any)e+=`${this.escape(t)}*`;return e+`${this.escape(this.final)})`}static _escapeRegExp(e){return e.replace(/[$()*+./?[\\\]^{|}-]/g,"\\$&")}}class eg{static parse(e,t){let s;if(null===e.readSequence())return null;let r="",i=!1,n=Buffer.alloc(0);if(e.length){let t=e.offset+e.length;r=e.readString()??"",e.offset<t&&1===e.peek()&&(i=e.readBoolean()??!1),e.offset<t&&(n=e.readString(4,!0)??Buffer.alloc(0))}switch(r){case d.type:s=new d({critical:i});break;case f.type:s=new f({critical:i});break;case p.type:s=new p({critical:i});break;case g.type:s=new g({critical:i});break;default:s=t.find(e=>e.type===r)}if(!s)return null;let a=new h(n);return s.parse(a),s}}class ew{version=3;messageId=0;controls;constructor(e){this.messageId=e.messageId,this.controls=e.controls}write(){let e=new u;if(e.startSequence(),e.writeInt(this.messageId),e.startSequence(this.protocolOperation),this.writeMessage(e),e.endSequence(),this.controls?.length){for(let t of(e.startSequence(160),this.controls))t.write(e);e.endSequence()}return e.endSequence(),e.buffer}parse(e,t){if(this.controls=[],this.parseMessage(e),160===e.peek()){e.readSequence();let s=e.offset+e.length;for(;e.offset<s;){let s=eg.parse(e,t);s&&this.controls.push(s)}}}toString(){return JSON.stringify({messageId:this.messageId,messageType:this.constructor.name},null,2)}parseMessage(e){}writeMessage(e){}}class em extends ew{protocolOperation;abandonId;constructor(e){super(e),this.protocolOperation=80,this.abandonId=e.abandonId??0}writeMessage(e){let t=this.abandonId,r=4;for(;((0xff800000&t)==0||(0xff800000&t)==0xff800000)&&r>1;)r-=1,t<<=8;for(s.ok(r<=4);r-- >0;)e.writeByte((0xff000000&t)>>24),t<<=8}parseMessage(e){let{length:t}=e;if(t){let s,r=1,i=e.buffer[r]??0;s=127&i;for(let i=1;i<t;i+=1)s<<=8,r+=1,s|=255&(e.buffer[r]??0);(128&i)==128&&(s=-s),e.offset+=t,this.abandonId=s}else this.abandonId=0}}let eb=new r.TextDecoder("utf8",{fatal:!0});class ey{buffers=[];type;values;constructor(e={}){this.type=e.type??"",this.values=e.values??[]}get parsedBuffers(){return this.buffers}write(e){e.startSequence();let{type:t}=this;if(e.writeString(t),e.startSequence(49),this.values.length)for(let t of this.values)Buffer.isBuffer(t)?e.writeBuffer(t,4):e.writeString(t);else e.writeStringArray([]);e.endSequence(),e.endSequence()}parse(e){e.readSequence(),this.type=e.readString()??"";let t=this._isBinaryType();if(49===e.peek()&&e.readSequence(49)){let s=e.offset+e.length;for(;e.offset<s;){let s=e.readString(4,!0)??Buffer.alloc(0);if(this.buffers.push(s),t)this.values.push(s);else try{let e=eb.decode(s);this.values.push(e)}catch{this.values.push(s)}}}}_isBinaryType(){return/;binary$/i.test(this.type||"")}}class eS extends ew{protocolOperation;dn;attributes;constructor(e){super(e),this.protocolOperation=104,this.dn=e.dn,this.attributes=e.attributes??[]}writeMessage(e){for(let t of(e.writeString(this.dn),e.startSequence(),this.attributes))t.write(e);e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new ey;t.parse(e),this.attributes.push(t)}}}class eO extends ew{status;matchedDN;errorMessage;constructor(e){super(e),this.status=e.status??0,this.matchedDN=e.matchedDN??"",this.errorMessage=e.errorMessage??""}parseMessage(e){this.status=e.readEnumeration()??0,this.matchedDN=e.readString()??"",this.errorMessage=e.readString()??""}}class ev extends eO{protocolOperation;constructor(e){super(e),this.protocolOperation=105}}let ex=["EXTERNAL","PLAIN","DIGEST-MD5","SCRAM-SHA-1"];class ek extends ew{protocolOperation;dn;password;mechanism;constructor(e){super(e),this.protocolOperation=96,this.dn=e.dn??"",this.password=e.password??"",this.mechanism=e.mechanism}writeMessage(e){e.writeInt(this.version),e.writeString(this.dn),this.mechanism?(e.startSequence(163),e.writeString(this.mechanism),e.writeString(this.password),e.endSequence()):e.writeString(this.password,128)}parseMessage(e){this.version=e.readInt()??3,this.dn=e.readString()??"";let t=e.peek();if(128!==t){let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Authentication type not supported: ${e}`)}this.password=e.readString(128)??""}}class eE extends eO{protocolOperation;data=[];constructor(e){super(e),this.protocolOperation=97}parseMessage(e){for(super.parseMessage(e);e.remain>0;){let t=e.peek();if(160===t)break;this.data.push(e.readString("number"==typeof t?t:void 0)??"")}}}class eL extends ew{protocolOperation;dn;attribute;value;constructor(e){super(e),this.protocolOperation=110,this.attribute=e.attribute??"",this.value=e.value??"",this.dn=e.dn??""}writeMessage(e){e.writeString(this.dn),e.startSequence(),e.writeString(this.attribute),e.writeString(this.value),e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence(),this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??""}}var eA=((t=eA||{})[t.compareTrue=6]="compareTrue",t[t.compareFalse=5]="compareFalse",t[t.noSuchAttribute=22]="noSuchAttribute",t[t.noSuchObject=50]="noSuchObject",t);class eM extends eO{protocolOperation;constructor(e){super(e),this.protocolOperation=111}}class eI extends ew{protocolOperation;dn;constructor(e){super(e),this.protocolOperation=74,this.dn=e.dn??""}writeMessage(e){for(let t of Buffer.from(this.dn))e.writeByte(t)}parseMessage(e){let{length:t}=e;this.dn=e.buffer.subarray(0,t).toString("utf8"),e.offset+=e.length}}class eq extends eO{protocolOperation;constructor(e){super(e),this.protocolOperation=107}}class eB extends ew{protocolOperation;oid;value;constructor(e){super(e),this.protocolOperation=119,this.oid=e.oid??"",this.value=e.value??""}writeMessage(e){e.writeString(this.oid,128),Buffer.isBuffer(this.value)?e.writeBuffer(this.value,129):this.value&&e.writeString(this.value,129)}parseMessage(e){if(this.oid=e.readString(128)??"",129===e.peek())try{this.value=e.readString(129)??""}catch{this.value=e.readString(129,!0)??Buffer.alloc(0)}}}class eD extends eO{protocolOperation;oid;value;constructor(e){super(e),this.protocolOperation=120,this.oid=e.oid,this.value=e.value}parseMessage(e){super.parseMessage(e),138===e.peek()&&(this.oid=e.readString(138)??""),139===e.peek()&&(this.value=e.readString(139)??void 0)}}class eC extends ew{protocolOperation;deleteOldRdn;dn;newRdn;newSuperior;constructor(e){super(e),this.protocolOperation=108,this.deleteOldRdn=!1!==e.deleteOldRdn,this.dn=e.dn??"",this.newRdn=e.newRdn??"",this.newSuperior=e.newSuperior??""}writeMessage(e){e.writeString(this.dn),e.writeString(this.newRdn),e.writeBoolean(this.deleteOldRdn),this.newSuperior&&e.writeString(this.newSuperior,128)}parseMessage(e){this.dn=e.readString()??"",this.newRdn=e.readString()??"",this.deleteOldRdn=e.readBoolean()??!1,128===e.peek()&&(this.newSuperior=e.readString(128)??"")}}class e_ extends eO{protocolOperation;constructor(e){super(e),this.protocolOperation=109}}class eP{operation;modification;constructor(e={modification:new ey}){this.operation=e.operation??"add",this.modification=e.modification}write(e){switch(e.startSequence(),this.operation){case"add":e.writeEnumeration(0);break;case"delete":e.writeEnumeration(1);break;case"replace":e.writeEnumeration(2);break;default:throw Error(`Unknown change operation: ${this.operation}`)}this.modification.write(e),e.endSequence()}parse(e){e.readSequence();let t=e.readEnumeration();switch(t){case 0:this.operation="add";break;case 1:this.operation="delete";break;case 2:this.operation="replace";break;case null:throw Error("Unknown change operation - <null> operation value");default:throw Error(`Unknown change operation: 0x${t.toString(16)}`)}this.modification=new ey,this.modification.parse(e)}}class eT extends ew{protocolOperation;dn;changes;constructor(e){super(e),this.protocolOperation=102,this.dn=e.dn??"",this.changes=e.changes??[]}writeMessage(e){for(let t of(e.writeString(this.dn),e.startSequence(),this.changes))t.write(e);e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new eP;t.parse(e),this.changes.push(t)}}}class e$ extends eO{protocolOperation;constructor(e){super(e),this.protocolOperation=103}}class ej extends eO{protocolOperation;name;attributes;constructor(e){super(e),this.protocolOperation=100,this.name=e.name??"",this.attributes=e.attributes??[]}parseMessage(e){this.name=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new ey;t.parse(e),this.attributes.push(t)}}toObject(e,t){let s={dn:this.name},r=new Set;for(let e of this.attributes){r.add(e.type.toLocaleLowerCase());let{values:i}=e;(t.includes(e.type)||i.some(e=>Buffer.isBuffer(e)))&&(i=e.parsedBuffers),i.length?1===i.length?s[e.type]=i[0]??[]:s[e.type]=i:s[e.type]=[]}for(let t of e)void 0!==s[t]||r.has(t.toLocaleLowerCase())||(s[t]=[]);return s}}class eR extends eO{protocolOperation;uris;constructor(e){super(e),this.protocolOperation=115,this.uris=e.uris??[]}parseMessage(e){let t=e.offset+e.length;for(;e.offset<t;){let t=e.readString()??"";this.uris.push(t)}}}class eN{static parseString(e){if(!e)throw Error("Filter cannot be empty");e.startsWith("(")||(e=`(${e})`);let t=eN._parseString(e,0,e),s=e.length-1;if(t.end<s)throw Error(`Unbalanced parens in filter string: ${e}`);return t.filter}static parse(e){let t,s=e.readSequence();switch(s){case 160:t=new en({filters:eN._parseSet(e)});break;case 168:(t=new ea).parse(e);break;case 163:(t=new eo).parse(e);break;case 169:(t=new ec).parse(e);break;case 165:(t=new eh).parse(e);break;case 166:(t=new eu).parse(e);break;case 162:t=new el({filter:eN.parse(e)});break;case 161:t=new ed({filters:eN._parseSet(e)});break;case 135:(t=new ef).parse(e);break;case 164:(t=new ep).parse(e);break;default:throw Error(`Invalid search filter type: 0x${s??"<null>"}`)}return t}static _parseString(e,t,s){let r,i=t,{length:n}=e;if("("!==e[i])throw Error(`Missing paren: ${e}. Full string: ${s}`);switch(e[i+=1]){case"&":{i+=1;let t=[];do{let r=eN._parseString(e,i,s);t.push(r.filter),i=r.end+1}while(i<n&&")"!==e[i])r=new en({filters:t});break}case"|":{i+=1;let t=[];do{let r=eN._parseString(e,i,s);t.push(r.filter),i=r.end+1}while(i<n&&")"!==e[i])r=new ed({filters:t});break}case"!":{let t=eN._parseString(e,i+1,s);r=new el({filter:t.filter}),i=t.end+1;break}default:{let t=e.indexOf(")",i);if(-1===t)throw Error(`Unbalanced parens: ${e}. Full string: ${s}`);r=eN._parseExpressionFilterFromString(e.substring(i,t)),i=t}}return{end:i,filter:r}}static _parseExpressionFilterFromString(e){let t,s;if(e.startsWith(":"))t="",s=e;else{let r=/^[\w-]+/.exec(e);if(r?.length)[t]=r,s=e.slice(t.length);else throw Error(`Invalid attribute name: ${e}`)}if("=*"===s)return new ef({attribute:t});if(s.startsWith("=")){if((s=s.slice(1)).includes("*")){let e=eN._unescapeSubstring(s);return new ep({attribute:t,initial:e.initial,any:e.any,final:e.final})}return new eo({attribute:t,value:eN._unescapeHexValues(s)})}if(s.startsWith(">")&&"="===s[1])return new eh({attribute:t,value:eN._unescapeHexValues(s.slice(2))});if(s.startsWith("<")&&"="===s[1])return new eu({attribute:t,value:eN._unescapeHexValues(s.slice(2))});if(s.startsWith("~")&&"="===s[1])return new ea({attribute:t,value:eN._unescapeHexValues(s.slice(2))});if(s.startsWith(":"))return eN._parseExtensibleFilterFromString(t,s);throw Error(`Invalid expression: ${e}`)}static _parseExtensibleFilterFromString(e,t){let s,r=!1,i=t.split(":");if(i.length<=1)throw Error(`Invalid extensible filter: ${t}`);if(i.shift(),i[0]?.toLowerCase()==="dn"&&(r=!0,i.shift()),i.length&&!i[0]?.startsWith("=")&&(s=i.shift()),i.length&&!i[0]?.startsWith("="))throw Error(`Missing := in extensible filter: ${t}`);let n=i.join(":").slice(1);return new ec({matchType:e,dnAttributes:r,rule:s,value:eN._unescapeHexValues(n)})}static _unescapeHexValues(e){let t=0,s=e.length,r="";for(;t<s;){let s=e[t];switch(s){case"(":throw Error(`Illegal unescaped character: ${s} in value: ${e}`);case"\\":{let s=e.slice(t+1,t+3);if(null===/^[\dA-Fa-f]{2}$/.exec(s))throw Error(`Invalid escaped hex character: ${s} in value: ${e}`);r+=String.fromCharCode(Number.parseInt(s,16)),t+=3;break}default:s&&(r+=s),t+=1}}return r}static _unescapeSubstring(e){let t=e.split("*");if(t.length<2)throw Error(`Wildcard missing: ${e}`);return{initial:eN._unescapeHexValues(t.shift()??""),final:eN._unescapeHexValues(t.pop()??""),any:t.map(e=>eN._unescapeHexValues(e))}}static _parseSet(e){let t=[],s=e.offset+e.length;for(;e.offset<s;)t.push(eN.parse(e));return t}}class ez extends ew{protocolOperation;baseDN;scope;derefAliases;sizeLimit;timeLimit;returnAttributeValues;filter;attributes;explicitBufferAttributes;constructor(e){super(e),this.protocolOperation=99,this.baseDN=e.baseDN??"",this.scope=e.scope??"sub",this.derefAliases=e.derefAliases??"never",this.sizeLimit=e.sizeLimit??0,this.timeLimit=e.timeLimit??10,this.returnAttributeValues=!1!==e.returnAttributeValues,this.filter=e.filter,this.attributes=e.attributes??[],this.explicitBufferAttributes=e.explicitBufferAttributes??[]}writeMessage(e){switch(e.writeString(this.baseDN),this.scope){case"base":e.writeEnumeration(0);break;case"one":e.writeEnumeration(1);break;case"sub":e.writeEnumeration(2);break;case"children":case"subordinates":e.writeEnumeration(3);break;default:throw Error(`Invalid search scope: ${this.scope}`)}switch(this.derefAliases){case"never":e.writeEnumeration(0);break;case"search":e.writeEnumeration(1);break;case"find":e.writeEnumeration(2);break;case"always":e.writeEnumeration(3);break;default:throw Error(`Invalid deref alias: ${this.derefAliases}`)}for(let t of(e.writeInt(this.sizeLimit),e.writeInt(this.timeLimit),e.writeBoolean(!this.returnAttributeValues),this.filter.write(e),e.startSequence(),this.attributes))e.writeString(t);e.endSequence()}parseMessage(e){this.baseDN=e.readString()??"";let t=e.readEnumeration();switch(t){case 0:this.scope="base";break;case 1:this.scope="one";break;case 2:this.scope="sub";break;case 3:this.scope="children";break;default:throw Error(`Invalid search scope: ${t??"<null>"}`)}let s=e.readEnumeration();switch(t){case 0:this.derefAliases="never";break;case 1:this.derefAliases="search";break;case 2:this.derefAliases="find";break;case 3:this.derefAliases="always";break;default:throw Error(`Invalid deref alias: ${s??"<null>"}`)}if(this.sizeLimit=e.readInt()??0,this.timeLimit=e.readInt()??0,this.returnAttributeValues=!e.readBoolean(),this.filter=eN.parse(e),48===e.peek()){e.readSequence();let t=e.offset+e.length;for(;e.offset<t;)this.attributes.push((e.readString()??"").toLowerCase())}}}class eF extends eO{protocolOperation;searchEntries;searchReferences;constructor(e){super(e),this.protocolOperation=101,this.searchEntries=e.searchEntries??[],this.searchReferences=e.searchReferences??[]}}class eU extends ew{protocolOperation;constructor(e){super(e),this.protocolOperation=66}}class eV extends o.EventEmitter{buffer;read(e,t){let s,r,i;this.buffer?this.buffer=Buffer.concat([this.buffer,e]):this.buffer=e;let n=new h(this.buffer),a=null;try{a=n.readSequence()}catch(e){this.emit("error",e)}if(a&&!(n.remain<n.length)){n.remain>n.length&&(s=this.buffer.subarray(n.offset+n.length),n.setBufferSize(n.offset+n.length)),delete this.buffer;try{if(r=n.readInt(),null==r)throw Error("Unable to read message id");if(i=n.readSequence(),null==i)throw Error(`Unable to read protocol operation sequence for message: ${r}`);let e=t.get(`${r}`),s=this._getMessageFromProtocolOperation(r,i,n,e?.message);this.emit("message",s)}catch(e){if(r){e.messageDetails={messageId:r},i&&(e.messageDetails.protocolOperation=i),this.emit("error",e);return}this.emit("error",e);return}s&&this.read(s,t)}}_getMessageFromProtocolOperation(e,t,s,r){let i;switch(t){case 97:i=new eE({messageId:e});break;case 105:i=new ev({messageId:e});break;case 111:i=new eM({messageId:e});break;case 107:i=new eq({messageId:e});break;case 120:i=new eD({messageId:e});break;case 109:i=new e_({messageId:e});break;case 103:i=new e$({messageId:e});break;case 101:i=new eF({messageId:e});break;case 100:i=new ej({messageId:e});break;case 115:i=new eR({messageId:e});break;default:{let s=new w(`Protocol Operation not supported: 0x${t.toString(16)}`);throw s.messageDetails={messageId:e,protocolOperation:t},s}}return i.parse(s,r?.controls??[]),i}}class eH{static parse(e){if(!e)return new F;switch(e.status){case 1:return new V(e.errorMessage);case 2:return new H(e.errorMessage);case 3:return new K(e.errorMessage);case 4:return new G(e.errorMessage);case 7:return new x(e.errorMessage);case 8:return new X(e.errorMessage);case 11:return new b(e.errorMessage);case 12:return new Z(e.errorMessage);case 13:return new E(e.errorMessage);case 14:return new J(e);case 16:return new j(e.errorMessage);case 17:return new et(e.errorMessage);case 18:return new M(e.errorMessage);case 19:return new L(e.errorMessage);case 20:return new Y(e.errorMessage);case 21:return new D(e.errorMessage);case 32:return new R(e.errorMessage);case 33:return new O(e.errorMessage);case 34:return new B(e.errorMessage);case 35:return new C(e.errorMessage);case 36:return new S(e.errorMessage);case 48:return new A(e.errorMessage);case 49:return new q(e.errorMessage);case 50:return new I(e.errorMessage);case 51:return new k(e.errorMessage);case 52:return new ee(e.errorMessage);case 53:return new er(e.errorMessage);case 54:return new _(e.errorMessage);case 64:return new T(e.errorMessage);case 65:return new U(e.errorMessage);case 66:return new N(e.errorMessage);case 67:return new z(e.errorMessage);case 68:return new v(e.errorMessage);case 69:return new $(e.errorMessage);case 70:return new W(e.errorMessage);case 71:return new y(e.errorMessage);case 95:return new P(e.errorMessage);case 112:return new Q(e.errorMessage);case 248:return new F(e.errorMessage);default:return new es(e.status,e.errorMessage)}}}let eW=0x80000000-1,eJ=(0,r.debuglog)("ldapts");Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class eG{clientOptions;messageId=1;host;port;secure;connected=!1;socket;connectTimer;messageParser=new eV;messageDetailsByMessageId=new Map;constructor(e){let t;this.clientOptions=e,this.clientOptions.timeout??=0,this.clientOptions.connectTimeout??=0,this.clientOptions.strictDN=!1!==this.clientOptions.strictDN;try{t=new URL(e.url)}catch{throw Error(`${e.url} is an invalid LDAP URL (protocol)`)}const s=t.protocol.replace(/:$/,"");if("ldap"!==s&&"ldaps"!==s)throw Error(`${e.url} is an invalid LDAP URL (protocol)`);const r="ldaps"===s,i=!!this.clientOptions.tlsOptions&&Object.values(this.clientOptions.tlsOptions).some(e=>void 0!==e);this.secure=r||i;let n=t.hostname;n.startsWith("[")&&n.endsWith("]")&&(n=n.slice(1,-1)),this.host=n||"localhost",t.port?this.port=Number(t.port):r?this.port=636:this.port=389,this.messageParser.on("error",e=>{if(e.messageDetails?.messageId){let t=this.messageDetailsByMessageId.get(e.messageDetails.messageId.toString());if(t){this.messageDetailsByMessageId.delete(e.messageDetails.messageId.toString()),t.reject(e);return}}e.stack&&eJ(e.stack)}),this.messageParser.on("message",this._handleSendResponse.bind(this))}get isConnected(){return!!this.socket&&this.connected}async startTLS(e={},t){this.isConnected||await this._connect(),await this.exop("1.3.6.1.4.1.1466.20037",void 0,t);let s=this.socket;s&&(s.removeListener("data",this.socketDataHandler),e.socket=s),this.socket=await new Promise((t,r)=>{let i=a.connect(e);i.once("secureConnect",()=>{i.removeAllListeners("error"),i.on("data",this.socketDataHandler),i.on("error",()=>{s&&s.destroy()}),t(i)}),i.once("error",e=>{i.removeAllListeners(),r(e)})}),s&&(this.socket.id=s.id)}async bind(e,t,s){if(s&&!Array.isArray(s)&&(s=[s]),"string"==typeof e&&ex.includes(e))return void await this.bindSASL(e,t,s);let r=new ek({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),password:t,controls:s});await this._sendBind(r)}async bindSASL(e,t,s){s&&!Array.isArray(s)&&(s=[s]);let r=new ek({messageId:this._nextMessageId(),mechanism:e,password:t,controls:s});await this._sendBind(r)}async add(e,t,s){let r;if(this.isConnected||await this._connect(),s&&!Array.isArray(s)&&(s=[s]),Array.isArray(t))r=t;else for(let[e,s]of(r=[],Object.entries(t))){let t;t=Array.isArray(s)?s:null==s?[]:[s],r.push(new ey({type:e,values:t}))}let i=new eS({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),attributes:r,controls:s}),n=await this._send(i);if(n?.status!==0)throw eH.parse(n)}async compare(e,t,s,r){this.isConnected||await this._connect(),r&&!Array.isArray(r)&&(r=[r]);let i=new eL({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),attribute:t,value:s,controls:r}),n=await this._send(i);switch(n?.status){case eA.compareTrue:return!0;case eA.compareFalse:return!1;default:throw eH.parse(n)}}async del(e,t){this.isConnected||await this._connect(),t&&!Array.isArray(t)&&(t=[t]);let s=new eI({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),controls:t}),r=await this._send(s);if(r?.status!==0)throw eH.parse(r)}async exop(e,t,s){this.isConnected||await this._connect(),s&&!Array.isArray(s)&&(s=[s]);let r=new eB({messageId:this._nextMessageId(),oid:e,value:t,controls:s}),i=await this._send(r);if(i?.status!==0)throw eH.parse(i);return{oid:i.oid,value:i.value}}async modify(e,t,s){this.isConnected||await this._connect(),Array.isArray(t)||(t=[t]),s&&!Array.isArray(s)&&(s=[s]);let r=new eT({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),changes:t,controls:s}),i=await this._send(r);if(i?.status!==0)throw eH.parse(i)}async modifyDN(e,t,s){let r;if(this.isConnected||await this._connect(),s&&!Array.isArray(s)&&(s=[s]),"string"==typeof t&&/[^\\],/.test(t)){let e=t.search(/[^\\],/);r=t.slice(e+2),t=t.slice(0,e+1)}let i=new eC({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),deleteOldRdn:!0,newRdn:"string"==typeof t?t:t.toString(),newSuperior:r,controls:s}),n=await this._send(i);if(n?.status!==0)throw eH.parse(n)}async search(e,t={},s){let r,i;if(this.isConnected||await this._connect(),s){for(let e of s=Array.isArray(s)?s.slice(0):[s])if(e instanceof f)throw Error("Should not specify PagedResultsControl")}else s=[];let n=100;"object"==typeof t.paged&&t.paged.pageSize?n=t.paged.pageSize:t.sizeLimit&&t.sizeLimit>1&&(n=t.sizeLimit-1);let a=!!t.paged;a&&(r=new f({value:{size:n}}),s.push(r)),i=t.filter?"string"==typeof t.filter?eN.parseString(t.filter):t.filter:new ef({attribute:"objectclass"});let o=new ez({messageId:-1,baseDN:"string"==typeof e?e:e.toString(),scope:t.scope,filter:i,attributes:t.attributes,explicitBufferAttributes:t.explicitBufferAttributes,returnAttributeValues:t.returnAttributeValues,sizeLimit:t.sizeLimit,timeLimit:t.timeLimit,controls:s}),c={searchEntries:[],searchReferences:[]};return await this._sendSearch(o,c,a,n,r),c}async *searchPaginated(e,t={},s){let r,i;if(this.isConnected||await this._connect(),s){for(let e of s=Array.isArray(s)?s.slice(0):[s])if(e instanceof f)throw Error("Should not specify PagedResultsControl")}else s=[];let n=100;"object"==typeof t.paged&&t.paged.pageSize?n=t.paged.pageSize:t.sizeLimit&&t.sizeLimit>1&&(n=t.sizeLimit-1),r=new f({value:{size:n}}),s.push(r),i=t.filter?"string"==typeof t.filter?eN.parseString(t.filter):t.filter:new ef({attribute:"objectclass"});let a=new ez({messageId:-1,baseDN:"string"==typeof e?e:e.toString(),scope:t.scope,filter:i,attributes:t.attributes,explicitBufferAttributes:t.explicitBufferAttributes,returnAttributeValues:t.returnAttributeValues,sizeLimit:t.sizeLimit,timeLimit:t.timeLimit,controls:s});do{let e={searchEntries:[],searchReferences:[]};r=await this._sendSearch(a,e,!0,n,r,!1),yield e}while(r)}async unbind(){try{if(!this.connected||!this.socket)return;let e=new eU({messageId:this._nextMessageId()});await this._send(e)}finally{this._destroySocket(this.socket)}}[Symbol.asyncDispose](){return this.unbind()}async _sendBind(e){this.isConnected||await this._connect();let t=await this._send(e);if(t?.status!==0)throw eH.parse(t)}async _sendSearch(e,t,s,r,i,n=!0){e.messageId=this._nextMessageId();let a=await this._send(e);if(a?.status!==0&&!(a?.status===4&&e.sizeLimit))throw eH.parse(a);for(let s of a.searchEntries)t.searchEntries.push(s.toObject(e.attributes,e.explicitBufferAttributes));for(let e of a.searchReferences)t.searchReferences.push(...e.uris);if(s&&(a.searchEntries.length||a.searchReferences.length)&&i){let o;for(let e of a.controls??[])if(e instanceof f){o=e;break}if(o?.value?.cookie?.length){if(i.value=i.value??{size:r},i.value.cookie=o.value.cookie,!n)return i;await this._sendSearch(e,t,s,r,i,!0)}}}socketDataHandler=e=>{this.messageParser&&this.messageParser.read(e,this.messageDetailsByMessageId)};_nextMessageId(){return this.messageId+=1,this.messageId>=eW&&(this.messageId=1),this.messageId}_connect(){if(!this.isConnected)return new Promise((e,t)=>{this.secure?(this.socket=a.connect(this.port,this.host,this.clientOptions.tlsOptions),this.socket.id=i.randomUUID(),this.socket.once("secureConnect",()=>{this._onConnect(e)})):(this.socket=n.connect(this.port,this.host),this.socket.id=i.randomUUID(),this.socket.once("connect",()=>{this._onConnect(e)})),this.socket.once("error",e=>{this._destroySocket(this.socket),t(e)}),this.clientOptions.connectTimeout&&(this.connectTimer=setTimeout(()=>{this._destroySocket(this.socket),t(Error("Connection timeout"))},this.clientOptions.connectTimeout))})}_onConnect(e){this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0),this.socket&&(this.socket.removeAllListeners("error"),this.socket.removeAllListeners("connect"),this.socket.removeAllListeners("secureConnect")),this.connected=!0;let t=e=>{for(let[t,s]of this.messageDetailsByMessageId.entries())s.message instanceof eU?s.resolve():s.reject(Error(`Socket error. Message type: ${s.message.constructor.name} (0x${s.message.protocolOperation.toString(16)})
${e.message||(e.stack??"Unknown socket error")}`)),this.messageDetailsByMessageId.delete(t);this.socket&&this.socket.destroy()};function s(){this&&this.end()}function r(){this&&this.end()}let i=this;this.socket&&(this.socket.on("error",t),this.socket.on("close",function e(){for(let[n,a]of(this&&(this.removeListener("error",t),this.removeListener("close",e),this.removeListener("data",i.socketDataHandler),this.removeListener("end",s),this.removeListener("timeout",r)),this===i.socket&&(i.connected=!1,delete i.socket,i.connectTimer&&(clearTimeout(i.connectTimer),i.connectTimer=void 0)),i.messageDetailsByMessageId.entries()))a.socket.id===this.id&&(a.message instanceof eU?a.resolve():a.reject(Error(`Connection closed before message response was received. Message type: ${a.message.constructor.name} (0x${a.message.protocolOperation.toString(16)})`)),i.messageDetailsByMessageId.delete(n))}),this.socket.on("data",this.socketDataHandler),this.socket.on("end",s),this.socket.on("timeout",r)),e()}_destroySocket(e){e&&(this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0),e.removeAllListeners("error"),e.on("error",()=>{}),e.end(),e.destroy(),e===this.socket&&(this.connected=!1,this.socket=void 0))}_send(e){if(!this.connected||!this.socket)throw Error("Socket connection not established");let t=e.write(),s=this.clientOptions.timeout?setTimeout(()=>{let t=this.messageDetailsByMessageId.get(e.messageId.toString());t&&(this._destroySocket(t.socket),i(Error(`${e.constructor.name}: Operation timed out`)))},this.clientOptions.timeout):null,r=()=>{},i=()=>{},n=new Promise((e,t)=>{r=e,i=t}).finally(()=>{s&&clearTimeout(s)});return this.messageDetailsByMessageId.set(e.messageId.toString(),{message:e,resolve:r,reject:i,timeoutTimer:s,socket:this.socket}),e.password?eJ(`Sending message: ${JSON.stringify({...e,password:"__redacted__"})}`):eJ(`Sending message: ${JSON.stringify(e)}`),this.socket.write(t,()=>{e instanceof em?(eJ(`Abandoned message: ${e.messageId}`),this.messageDetailsByMessageId.delete(e.messageId.toString()),r()):e instanceof eU?(eJ("Unbind success. Ending socket"),this.socket&&this._destroySocket(this.socket)):eJ("Message sent successfully.")}),n}_handleSendResponse(e){let t=this.messageDetailsByMessageId.get(e.messageId.toString());t?e instanceof ej?(t.searchEntries=t.searchEntries??[],t.searchEntries.push(e)):e instanceof eR?(t.searchReferences=t.searchReferences??[],t.searchReferences.push(e)):(e instanceof eF&&(t.searchEntries&&e.searchEntries.push(...t.searchEntries),t.searchReferences&&e.searchReferences.push(...t.searchReferences)),this.messageDetailsByMessageId.delete(e.messageId.toString()),t.resolve(e)):eJ(`Unable to find details related to message response: ${JSON.stringify(e)}`)}}var eX=e.i(82593);function eK(e){return{url:e.url,baseDn:e.baseDn,userFilter:e.userFilter,bindDn:e.bindDn,bindPassword:e.bindPassword,timeoutMs:e.timeoutMs,adminEmails:e.adminEmails}}async function eQ(){let e=await (0,eX.readStoredLdapConfig)();if(e)return eK(e);let t=process.env.LDAP_URL?.trim(),s=process.env.LDAP_BASE_DN?.trim();return t&&s?{url:t,baseDn:s,userFilter:process.env.LDAP_USER_FILTER?.trim()||"(mail={{email}})",bindDn:process.env.LDAP_BIND_DN?.trim()||void 0,bindPassword:process.env.LDAP_BIND_PASSWORD?.trim()||void 0,timeoutMs:Number(process.env.LDAP_TIMEOUT_MS??5e3),adminEmails:(process.env.LDAP_ADMIN_EMAILS??"").split(";").map(e=>e.trim().toLowerCase()).filter(Boolean)}:null}function eY(e,t){return t.adminEmails.includes(e.trim().toLowerCase())?"administrativo":"tecnico"}async function eZ(e,t){let s=await eQ();if(!s)return{ok:!1,error:"LDAP no est configurado."};let r=e.trim().toLowerCase(),i=new eG({url:s.url,timeout:s.timeoutMs,connectTimeout:s.timeoutMs});try{var n;if(s.bindDn&&s.bindPassword)await i.bind(s.bindDn,s.bindPassword);else{await i.bind(r,t);let e={email:r,role:eY(r,s),source:"ldap"};return{ok:!0,user:e}}let e=(n=s.userFilter,n.replace(/\{\{\s*email\s*\}\}/gi,r)),a=(await i.search(s.baseDn,{scope:"sub",filter:e,attributes:["dn","mail"],sizeLimit:1})).searchEntries[0];if(!a||"string"!=typeof a.dn)return{ok:!1,error:"Usuario no encontrado en LDAP."};let o=a.dn;await i.unbind();let c=new eG({url:s.url,timeout:s.timeoutMs,connectTimeout:s.timeoutMs});try{await c.bind(o,t);let e={email:"string"==typeof a.mail&&a.mail.trim()?a.mail.toLowerCase():r,role:eY("string"==typeof a.mail&&a.mail.trim()?a.mail.toLowerCase():r,s),source:"ldap"};return{ok:!0,user:e}}finally{await c.unbind()}}catch{return{ok:!1,error:"Credenciales LDAP invlidas o servidor no disponible."}}finally{try{await i.unbind()}catch{}}}async function e1(e){let t=e?eK(e):await eQ();if(!t)return{ok:!1,message:"LDAP no est configurado."};let s=new eG({url:t.url,timeout:t.timeoutMs,connectTimeout:t.timeoutMs});try{return t.bindDn&&t.bindPassword?await s.bind(t.bindDn,t.bindPassword):await s.search(t.baseDn,{scope:"base",filter:"(objectClass=*)",attributes:["dn"],sizeLimit:1}),{ok:!0,message:"Conexin LDAP exitosa."}}catch(e){return{ok:!1,message:e instanceof Error&&e.message?e.message:"No se pudo conectar con LDAP."}}finally{try{await s.unbind()}catch{}}}e.s(["authenticateLdap",()=>eZ,"testLdapConnection",()=>e1],50514)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__09632b0c._.js.map