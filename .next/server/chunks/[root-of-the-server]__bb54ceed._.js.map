{"version":3,"sources":["../../../src/lib/auth/cookies.ts","../../../src/lib/auth/local-user-store.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getSessionCookieName, getSessionMaxAge } from \"@/lib/auth/session\";\n\nexport function setSessionCookie(response: NextResponse, token: string) {\n  response.cookies.set({\n    name: getSessionCookieName(),\n    value: token,\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    path: \"/\",\n    maxAge: getSessionMaxAge(),\n  });\n}\n\nexport function clearSessionCookie(response: NextResponse) {\n  response.cookies.set({\n    name: getSessionCookieName(),\n    value: \"\",\n    httpOnly: true,\n    secure: process.env.NODE_ENV === \"production\",\n    sameSite: \"lax\",\n    path: \"/\",\n    maxAge: 0,\n  });\n}","import { randomBytes, scrypt as scryptCallback, timingSafeEqual } from \"node:crypto\";\nimport { promises as fs } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { promisify } from \"node:util\";\nimport { kv } from \"@vercel/kv\";\n\nconst scrypt = promisify(scryptCallback);\nconst STORE_DIR = join(process.cwd(), \"uploads\");\nconst STORE_PATH = join(STORE_DIR, \"local-users.json\");\nconst KV_USERS_KEY = \"dashboard:local-users\";\n\ntype StoredLocalUser = {\n  email: string;\n  passwordHash: string;\n  salt: string;\n};\n\ntype StoredLocalUserFile = {\n  users: StoredLocalUser[];\n};\n\nfunction isVercelKvConfigured(): boolean {\n  return Boolean(process.env.KV_REST_API_URL && process.env.KV_REST_API_TOKEN);\n}\n\nasync function readStoreFromKv(): Promise<StoredLocalUserFile> {\n  const payload = await kv.get<StoredLocalUserFile>(KV_USERS_KEY);\n\n  if (!payload || !Array.isArray(payload.users)) {\n    return { users: [] };\n  }\n\n  return {\n    users: payload.users.filter(\n      (item) =>\n        typeof item?.email === \"string\" &&\n        typeof item?.passwordHash === \"string\" &&\n        typeof item?.salt === \"string\",\n    ),\n  };\n}\n\nasync function writeStoreToKv(data: StoredLocalUserFile): Promise<void> {\n  await kv.set(KV_USERS_KEY, data);\n}\n\nasync function ensureStoreFile(): Promise<void> {\n  await fs.mkdir(STORE_DIR, { recursive: true });\n\n  try {\n    await fs.access(STORE_PATH);\n  } catch {\n    const initialData: StoredLocalUserFile = { users: [] };\n    await fs.writeFile(STORE_PATH, JSON.stringify(initialData, null, 2), \"utf8\");\n  }\n}\n\nasync function readStore(): Promise<StoredLocalUserFile> {\n  if (isVercelKvConfigured()) {\n    return readStoreFromKv();\n  }\n\n  await ensureStoreFile();\n  const raw = await fs.readFile(STORE_PATH, \"utf8\");\n\n  try {\n    const parsed = JSON.parse(raw) as StoredLocalUserFile;\n    if (!parsed || !Array.isArray(parsed.users)) {\n      return { users: [] };\n    }\n\n    return {\n      users: parsed.users.filter(\n        (item) =>\n          typeof item?.email === \"string\" &&\n          typeof item?.passwordHash === \"string\" &&\n          typeof item?.salt === \"string\",\n      ),\n    };\n  } catch {\n    return { users: [] };\n  }\n}\n\nasync function writeStore(data: StoredLocalUserFile): Promise<void> {\n  if (isVercelKvConfigured()) {\n    await writeStoreToKv(data);\n    return;\n  }\n\n  await ensureStoreFile();\n  await fs.writeFile(STORE_PATH, JSON.stringify(data, null, 2), \"utf8\");\n}\n\nasync function hashPassword(password: string, salt: string): Promise<string> {\n  const derivedKey = (await scrypt(password, salt, 64)) as Buffer;\n  return derivedKey.toString(\"hex\");\n}\n\nexport async function listStoredLocalUserEmails(): Promise<string[]> {\n  const store = await readStore();\n  return store.users.map((user) => user.email).sort((a, b) => a.localeCompare(b));\n}\n\nexport async function upsertStoredLocalUser(email: string, password: string): Promise<void> {\n  const normalizedEmail = email.trim().toLowerCase();\n  const salt = randomBytes(16).toString(\"hex\");\n  const passwordHash = await hashPassword(password, salt);\n\n  const store = await readStore();\n  const nextUsers = store.users.filter((user) => user.email !== normalizedEmail);\n  nextUsers.push({ email: normalizedEmail, passwordHash, salt });\n\n  await writeStore({ users: nextUsers });\n}\n\nexport async function removeStoredLocalUser(email: string): Promise<boolean> {\n  const normalizedEmail = email.trim().toLowerCase();\n  const store = await readStore();\n  const nextUsers = store.users.filter((user) => user.email !== normalizedEmail);\n\n  if (nextUsers.length === store.users.length) {\n    return false;\n  }\n\n  await writeStore({ users: nextUsers });\n  return true;\n}\n\nexport async function verifyStoredLocalUser(email: string, password: string): Promise<boolean> {\n  const normalizedEmail = email.trim().toLowerCase();\n  const store = await readStore();\n  const user = store.users.find((item) => item.email === normalizedEmail);\n\n  if (!user) {\n    return false;\n  }\n\n  const providedHash = await hashPassword(password, user.salt);\n  const expected = Buffer.from(user.passwordHash, \"hex\");\n  const actual = Buffer.from(providedHash, \"hex\");\n\n  if (expected.length !== actual.length) {\n    return false;\n  }\n\n  return timingSafeEqual(expected, actual);\n}"],"names":[],"mappings":"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"}