{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 70, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/lib/auth/local-user-store.ts"],"sourcesContent":["import { randomBytes, scrypt as scryptCallback, timingSafeEqual } from \"node:crypto\";\nimport { promises as fs } from \"node:fs\";\nimport { join } from \"node:path\";\nimport { promisify } from \"node:util\";\nimport { kv } from \"@vercel/kv\";\nimport type { UserRole } from \"@/lib/auth/types\";\n\nconst scrypt = promisify(scryptCallback);\nconst STORE_DIR = join(process.cwd(), \"uploads\");\nconst STORE_PATH = join(STORE_DIR, \"local-users.json\");\nconst KV_USERS_KEY = \"dashboard:local-users\";\n\ntype StoredLocalUser = {\n  email: string;\n  username: string;\n  firstName: string;\n  lastName: string;\n  role: UserRole;\n  passwordHash: string;\n  salt: string;\n};\n\nexport type LocalUserProfile = {\n  email: string;\n  username: string;\n  firstName: string;\n  lastName: string;\n  role: UserRole;\n};\n\ntype StoredLocalUserFile = {\n  users: StoredLocalUser[];\n};\n\ntype LegacyStoredLocalUser = {\n  email?: string;\n  passwordHash?: string;\n  salt?: string;\n  username?: string;\n  firstName?: string;\n  lastName?: string;\n  role?: UserRole;\n};\n\nfunction normalizeEmail(email: string): string {\n  return email.trim().toLowerCase();\n}\n\nfunction normalizeUsername(username: string): string {\n  return username.trim().toLowerCase();\n}\n\nfunction normalizeName(value: string): string {\n  return value.trim().replace(/\\s+/g, \" \");\n}\n\nfunction usernameFromEmail(email: string): string {\n  const localPart = normalizeEmail(email).split(\"@\")[0] ?? \"\";\n  return normalizeUsername(localPart || \"usuario\");\n}\n\nfunction normalizeRole(role: unknown): UserRole {\n  return role === \"tecnico\" ? \"tecnico\" : \"administrativo\";\n}\n\nfunction normalizeStoredUser(item: LegacyStoredLocalUser): StoredLocalUser | null {\n  if (\n    typeof item?.email !== \"string\" ||\n    typeof item?.passwordHash !== \"string\" ||\n    typeof item?.salt !== \"string\"\n  ) {\n    return null;\n  }\n\n  const email = normalizeEmail(item.email);\n  if (!email) {\n    return null;\n  }\n\n  const username =\n    typeof item.username === \"string\" && item.username.trim()\n      ? normalizeUsername(item.username)\n      : usernameFromEmail(email);\n\n  const firstName = typeof item.firstName === \"string\" ? normalizeName(item.firstName) : \"\";\n  const lastName = typeof item.lastName === \"string\" ? normalizeName(item.lastName) : \"\";\n  const role = normalizeRole(item.role);\n\n  return {\n    email,\n    username,\n    firstName,\n    lastName,\n    role,\n    passwordHash: item.passwordHash,\n    salt: item.salt,\n  };\n}\n\nfunction sortUsers(users: StoredLocalUser[]): StoredLocalUser[] {\n  return [...users].sort((a, b) => a.username.localeCompare(b.username) || a.email.localeCompare(b.email));\n}\n\nfunction isVercelKvConfigured(): boolean {\n  return Boolean(process.env.KV_REST_API_URL && process.env.KV_REST_API_TOKEN);\n}\n\nasync function readStoreFromKv(): Promise<StoredLocalUserFile> {\n  const payload = await kv.get<StoredLocalUserFile>(KV_USERS_KEY);\n\n  if (!payload || !Array.isArray(payload.users)) {\n    return { users: [] };\n  }\n\n  return {\n    users: payload.users\n      .map((item) => normalizeStoredUser(item as LegacyStoredLocalUser))\n      .filter((item): item is StoredLocalUser => item !== null),\n  };\n}\n\nasync function writeStoreToKv(data: StoredLocalUserFile): Promise<void> {\n  await kv.set(KV_USERS_KEY, data);\n}\n\nasync function ensureStoreFile(): Promise<void> {\n  await fs.mkdir(STORE_DIR, { recursive: true });\n\n  try {\n    await fs.access(STORE_PATH);\n  } catch {\n    const initialData: StoredLocalUserFile = { users: [] };\n    await fs.writeFile(STORE_PATH, JSON.stringify(initialData, null, 2), \"utf8\");\n  }\n}\n\nasync function readStore(): Promise<StoredLocalUserFile> {\n  if (isVercelKvConfigured()) {\n    return readStoreFromKv();\n  }\n\n  await ensureStoreFile();\n  const raw = await fs.readFile(STORE_PATH, \"utf8\");\n\n  try {\n    const parsed = JSON.parse(raw) as StoredLocalUserFile;\n    if (!parsed || !Array.isArray(parsed.users)) {\n      return { users: [] };\n    }\n\n    return {\n      users: parsed.users\n        .map((item) => normalizeStoredUser(item as LegacyStoredLocalUser))\n        .filter((item): item is StoredLocalUser => item !== null),\n    };\n  } catch {\n    return { users: [] };\n  }\n}\n\nasync function writeStore(data: StoredLocalUserFile): Promise<void> {\n  if (isVercelKvConfigured()) {\n    await writeStoreToKv(data);\n    return;\n  }\n\n  await ensureStoreFile();\n  await fs.writeFile(STORE_PATH, JSON.stringify(data, null, 2), \"utf8\");\n}\n\nasync function hashPassword(password: string, salt: string): Promise<string> {\n  const derivedKey = (await scrypt(password, salt, 64)) as Buffer;\n  return derivedKey.toString(\"hex\");\n}\n\nexport async function listStoredLocalUserEmails(): Promise<string[]> {\n  const store = await readStore();\n  return sortUsers(store.users).map((user) => user.email);\n}\n\nexport async function listStoredLocalUsers(): Promise<LocalUserProfile[]> {\n  const store = await readStore();\n  return sortUsers(store.users).map((user) => ({\n    email: user.email,\n    username: user.username,\n    firstName: user.firstName,\n    lastName: user.lastName,\n    role: user.role,\n  }));\n}\n\nexport async function upsertStoredLocalUser(\n  profile: LocalUserProfile,\n  password?: string,\n  previousIdentifier?: string,\n): Promise<void> {\n  const normalizedEmail = normalizeEmail(profile.email);\n  const normalizedUsername = normalizeUsername(profile.username);\n  const normalizedFirstName = normalizeName(profile.firstName);\n  const normalizedLastName = normalizeName(profile.lastName);\n  const normalizedRole = normalizeRole(profile.role);\n  const normalizedPreviousIdentifier = previousIdentifier?.trim().toLowerCase() ?? \"\";\n\n  const store = await readStore();\n  const existingUser = store.users.find(\n    (user) => user.email === normalizedEmail || user.username === normalizedUsername,\n  );\n\n  let salt = existingUser?.salt;\n  let passwordHash = existingUser?.passwordHash;\n\n  if (password && password.trim()) {\n    salt = randomBytes(16).toString(\"hex\");\n    passwordHash = await hashPassword(password, salt);\n  }\n\n  if (!salt || !passwordHash) {\n    throw new Error(\"Password is required for new local users.\");\n  }\n\n  const nextUsers = store.users.filter(\n    (user) =>\n      user.email !== normalizedEmail &&\n      user.username !== normalizedUsername &&\n      user.email !== normalizedPreviousIdentifier &&\n      user.username !== normalizedPreviousIdentifier,\n  );\n\n  nextUsers.push({\n    email: normalizedEmail,\n    username: normalizedUsername,\n    firstName: normalizedFirstName,\n    lastName: normalizedLastName,\n    role: normalizedRole,\n    passwordHash,\n    salt,\n  });\n\n  await writeStore({ users: sortUsers(nextUsers) });\n}\n\nexport async function removeStoredLocalUser(identifier: string): Promise<boolean> {\n  const normalizedIdentifier = identifier.trim().toLowerCase();\n  const store = await readStore();\n  const nextUsers = store.users.filter(\n    (user) => user.email !== normalizedIdentifier && user.username !== normalizedIdentifier,\n  );\n\n  if (nextUsers.length === store.users.length) {\n    return false;\n  }\n\n  await writeStore({ users: sortUsers(nextUsers) });\n  return true;\n}\n\nexport async function verifyStoredLocalUser(\n  identifier: string,\n  password: string,\n): Promise<LocalUserProfile | null> {\n  const normalizedIdentifier = identifier.trim().toLowerCase();\n  const store = await readStore();\n  const user = store.users.find(\n    (item) => item.email === normalizedIdentifier || item.username === normalizedIdentifier,\n  );\n\n  if (!user) {\n    return null;\n  }\n\n  const providedHash = await hashPassword(password, user.salt);\n  const expected = Buffer.from(user.passwordHash, \"hex\");\n  const actual = Buffer.from(providedHash, \"hex\");\n\n  if (expected.length !== actual.length) {\n    return null;\n  }\n\n  if (!timingSafeEqual(expected, actual)) {\n    return null;\n  }\n\n  return {\n    email: user.email,\n    username: user.username,\n    firstName: user.firstName,\n    lastName: user.lastName,\n    role: user.role,\n  };\n}"],"names":[],"mappings":"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"}},
    {"offset": {"line": 289, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/lib/auth/session.ts"],"sourcesContent":["import { jwtVerify, SignJWT } from \"jose\";\nimport type { AuthUser } from \"@/lib/auth/types\";\n\nconst SESSION_COOKIE_NAME = \"dashboard_session\";\nconst SESSION_DURATION_SECONDS = 60 * 60 * 12;\n\nfunction getJwtSecret(): Uint8Array {\n  const secret = process.env.AUTH_JWT_SECRET;\n  if (!secret) {\n    throw new Error(\"Falta AUTH_JWT_SECRET en variables de entorno.\");\n  }\n\n  return new TextEncoder().encode(secret);\n}\n\nexport function getSessionCookieName(): string {\n  return SESSION_COOKIE_NAME;\n}\n\nexport async function createSessionToken(user: AuthUser): Promise<string> {\n  const secret = getJwtSecret();\n\n  return new SignJWT({\n    email: user.email,\n    source: user.source,\n    username: user.username,\n    firstName: user.firstName,\n    lastName: user.lastName,\n    displayName: user.displayName,\n    role: user.role,\n  })\n    .setProtectedHeader({ alg: \"HS256\" })\n    .setSubject(user.email)\n    .setIssuedAt()\n    .setExpirationTime(`${SESSION_DURATION_SECONDS}s`)\n    .sign(secret);\n}\n\nexport async function verifySessionToken(token: string): Promise<AuthUser | null> {\n  try {\n    const secret = getJwtSecret();\n    const { payload } = await jwtVerify(token, secret);\n\n    const email = typeof payload.email === \"string\" ? payload.email : null;\n    const source = payload.source === \"ldap\" || payload.source === \"local\" ? payload.source : null;\n    const username = typeof payload.username === \"string\" ? payload.username : undefined;\n    const firstName = typeof payload.firstName === \"string\" ? payload.firstName : undefined;\n    const lastName = typeof payload.lastName === \"string\" ? payload.lastName : undefined;\n    const displayName = typeof payload.displayName === \"string\" ? payload.displayName : undefined;\n    const role = payload.role === \"administrativo\" || payload.role === \"tecnico\" ? payload.role : undefined;\n\n    if (!email || !source) {\n      return null;\n    }\n\n    return { email, source, username, firstName, lastName, displayName, role };\n  } catch {\n    return null;\n  }\n}\n\nexport function getSessionMaxAge(): number {\n  return SESSION_DURATION_SECONDS;\n}"],"names":[],"mappings":";;;;;;;;;;AAAA;AAAA;;AAGA,MAAM,sBAAsB;AAC5B,MAAM,2BAA2B,KAAK,KAAK;AAE3C,SAAS;IACP,MAAM,SAAS,QAAQ,GAAG,CAAC,eAAe;IAC1C,IAAI,CAAC,QAAQ;QACX,MAAM,IAAI,MAAM;IAClB;IAEA,OAAO,IAAI,cAAc,MAAM,CAAC;AAClC;AAEO,SAAS;IACd,OAAO;AACT;AAEO,eAAe,mBAAmB,IAAc;IACrD,MAAM,SAAS;IAEf,OAAO,IAAI,kKAAO,CAAC;QACjB,OAAO,KAAK,KAAK;QACjB,QAAQ,KAAK,MAAM;QACnB,UAAU,KAAK,QAAQ;QACvB,WAAW,KAAK,SAAS;QACzB,UAAU,KAAK,QAAQ;QACvB,aAAa,KAAK,WAAW;QAC7B,MAAM,KAAK,IAAI;IACjB,GACG,kBAAkB,CAAC;QAAE,KAAK;IAAQ,GAClC,UAAU,CAAC,KAAK,KAAK,EACrB,WAAW,GACX,iBAAiB,CAAC,GAAG,yBAAyB,CAAC,CAAC,EAChD,IAAI,CAAC;AACV;AAEO,eAAe,mBAAmB,KAAa;IACpD,IAAI;QACF,MAAM,SAAS;QACf,MAAM,EAAE,OAAO,EAAE,GAAG,MAAM,IAAA,sKAAS,EAAC,OAAO;QAE3C,MAAM,QAAQ,OAAO,QAAQ,KAAK,KAAK,WAAW,QAAQ,KAAK,GAAG;QAClE,MAAM,SAAS,QAAQ,MAAM,KAAK,UAAU,QAAQ,MAAM,KAAK,UAAU,QAAQ,MAAM,GAAG;QAC1F,MAAM,WAAW,OAAO,QAAQ,QAAQ,KAAK,WAAW,QAAQ,QAAQ,GAAG;QAC3E,MAAM,YAAY,OAAO,QAAQ,SAAS,KAAK,WAAW,QAAQ,SAAS,GAAG;QAC9E,MAAM,WAAW,OAAO,QAAQ,QAAQ,KAAK,WAAW,QAAQ,QAAQ,GAAG;QAC3E,MAAM,cAAc,OAAO,QAAQ,WAAW,KAAK,WAAW,QAAQ,WAAW,GAAG;QACpF,MAAM,OAAO,QAAQ,IAAI,KAAK,oBAAoB,QAAQ,IAAI,KAAK,YAAY,QAAQ,IAAI,GAAG;QAE9F,IAAI,CAAC,SAAS,CAAC,QAAQ;YACrB,OAAO;QACT;QAEA,OAAO;YAAE;YAAO;YAAQ;YAAU;YAAW;YAAU;YAAa;QAAK;IAC3E,EAAE,OAAM;QACN,OAAO;IACT;AACF;AAEO,SAAS;IACd,OAAO;AACT"}},
    {"offset": {"line": 362, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/app/api/auth/local-users/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { cookies } from \"next/headers\";\nimport {\n  listStoredLocalUsers,\n  LocalUserProfile,\n  removeStoredLocalUser,\n  upsertStoredLocalUser,\n} from \"@/lib/auth/local-user-store\";\nimport { getSessionCookieName, verifySessionToken } from \"@/lib/auth/session\";\nimport type { UserRole } from \"@/lib/auth/types\";\n\ntype LocalUserBody = {\n  username?: string;\n  firstName?: string;\n  lastName?: string;\n  email?: string;\n  password?: string;\n  identifier?: string;\n  role?: UserRole;\n};\n\nasync function requireAdminSession(): Promise<NextResponse | null> {\n  const cookieStore = await cookies();\n  const token = cookieStore.get(getSessionCookieName())?.value;\n\n  if (!token) {\n    return NextResponse.json({ error: \"No autenticado.\" }, { status: 401 });\n  }\n\n  const session = await verifySessionToken(token);\n  if (!session) {\n    return NextResponse.json({ error: \"Sesión inválida.\" }, { status: 401 });\n  }\n\n  if (session.role !== \"administrativo\") {\n    return NextResponse.json({ error: \"No autorizado.\" }, { status: 403 });\n  }\n\n  return null;\n}\n\nfunction normalizeEmail(email: string): string {\n  return email.trim().toLowerCase();\n}\n\nfunction isValidEmail(email: string): boolean {\n  return /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email);\n}\n\nfunction normalizeUsername(username: string): string {\n  return username.trim().toLowerCase();\n}\n\nfunction normalizeName(value: string): string {\n  return value.trim().replace(/\\s+/g, \" \");\n}\n\nfunction isValidUsername(username: string): boolean {\n  return /^[a-z0-9._-]{3,32}$/.test(username);\n}\n\nfunction normalizeRole(value: unknown): UserRole {\n  return value === \"tecnico\" ? \"tecnico\" : \"administrativo\";\n}\n\nfunction parseProfile(body: LocalUserBody): LocalUserProfile {\n  return {\n    username: normalizeUsername(body.username ?? \"\"),\n    firstName: normalizeName(body.firstName ?? \"\"),\n    lastName: normalizeName(body.lastName ?? \"\"),\n    email: normalizeEmail(body.email ?? \"\"),\n    role: normalizeRole(body.role),\n  };\n}\n\nfunction validateProfile(profile: LocalUserProfile): string | null {\n  if (!profile.username || !profile.firstName || !profile.lastName || !profile.email) {\n    return \"Debes enviar usuario, nombre, apellido, correo y rol.\";\n  }\n\n  if (!isValidUsername(profile.username)) {\n    return \"El usuario debe tener entre 3 y 32 caracteres (a-z, 0-9, punto, guión o guión bajo).\";\n  }\n\n  if (!isValidEmail(profile.email)) {\n    return \"El correo no tiene formato válido.\";\n  }\n\n  return null;\n}\n\nexport async function GET() {\n  const unauthorizedResponse = await requireAdminSession();\n  if (unauthorizedResponse) {\n    return unauthorizedResponse;\n  }\n\n  try {\n    const users = await listStoredLocalUsers();\n    return NextResponse.json({ users });\n  } catch {\n    return NextResponse.json(\n      { error: \"No se pudo cargar la lista de usuarios locales.\" },\n      { status: 500 },\n    );\n  }\n}\n\nexport async function POST(request: Request) {\n  const unauthorizedResponse = await requireAdminSession();\n  if (unauthorizedResponse) {\n    return unauthorizedResponse;\n  }\n\n  try {\n    const body = (await request.json()) as LocalUserBody;\n    const profile = parseProfile(body);\n    const password = body.password?.trim() ?? \"\";\n\n    const validationError = validateProfile(profile);\n    if (validationError) {\n      return NextResponse.json(\n        { error: validationError },\n        { status: 400 },\n      );\n    }\n\n    if (!password) {\n      return NextResponse.json(\n        { error: \"Debes enviar contraseña.\" },\n        { status: 400 },\n      );\n    }\n\n    if (password.length < 8) {\n      return NextResponse.json(\n        { error: \"La contraseña debe tener al menos 8 caracteres.\" },\n        { status: 400 },\n      );\n    }\n\n    await upsertStoredLocalUser(profile, password);\n    return NextResponse.json({ ok: true });\n  } catch {\n    return NextResponse.json(\n      { error: \"No se pudo guardar el usuario local.\" },\n      { status: 500 },\n    );\n  }\n}\n\nexport async function PUT(request: Request) {\n  const unauthorizedResponse = await requireAdminSession();\n  if (unauthorizedResponse) {\n    return unauthorizedResponse;\n  }\n\n  try {\n    const body = (await request.json()) as LocalUserBody;\n    const profile = parseProfile(body);\n    const previousIdentifier = normalizeUsername(body.identifier ?? \"\");\n    const validationError = validateProfile(profile);\n\n    if (validationError) {\n      return NextResponse.json(\n        { error: validationError },\n        { status: 400 },\n      );\n    }\n\n    const password = body.password?.trim();\n\n    if (password && password.length < 8) {\n      return NextResponse.json(\n        { error: \"La contraseña debe tener al menos 8 caracteres.\" },\n        { status: 400 },\n      );\n    }\n\n    const users = await listStoredLocalUsers();\n    const existing = users.find(\n      (user) =>\n        user.username === previousIdentifier ||\n        user.username === profile.username ||\n        user.email === profile.email,\n    );\n    if (!existing) {\n      return NextResponse.json(\n        { error: \"Usuario no encontrado.\" },\n        { status: 404 },\n      );\n    }\n\n    await upsertStoredLocalUser(profile, password, previousIdentifier || existing.username);\n    return NextResponse.json({ ok: true });\n  } catch {\n    return NextResponse.json(\n      { error: \"No se pudo actualizar el usuario local.\" },\n      { status: 500 },\n    );\n  }\n}\n\nexport async function DELETE(request: Request) {\n  const unauthorizedResponse = await requireAdminSession();\n  if (unauthorizedResponse) {\n    return unauthorizedResponse;\n  }\n\n  try {\n    const body = (await request.json()) as LocalUserBody;\n    const identifier = normalizeUsername(body.identifier ?? body.username ?? body.email ?? \"\");\n\n    if (!identifier) {\n      return NextResponse.json(\n        { error: \"Debes indicar el usuario o correo a eliminar.\" },\n        { status: 400 },\n      );\n    }\n\n    const removed = await removeStoredLocalUser(identifier);\n    if (!removed) {\n      return NextResponse.json(\n        { error: \"Usuario no encontrado.\" },\n        { status: 404 },\n      );\n    }\n\n    return NextResponse.json({ ok: true });\n  } catch {\n    return NextResponse.json(\n      { error: \"No se pudo eliminar el usuario local.\" },\n      { status: 500 },\n    );\n  }\n}"],"names":[],"mappings":"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"}}]
}