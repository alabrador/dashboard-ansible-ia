{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/config/command-mappings.ts"],"sourcesContent":["export type CommandMapping = {\n      id: string;\n      aliases: string[];\n      templateId: number;\n      templateType: \"job\" | \"workflow\";\n      extraVars?: Record<string, string>;\n};\n\nexport const commandMappings: CommandMapping[] = [\n      {\n            id: \"actualizacion-cyberpanel\",\n            aliases: [\n                  \"actualizacion cyberpanel\",\n                  \"actualizar cyberpanel\",\n                  \"upgrade cyberpanel\",\n                  \"ejecutar actualizacion de cyberpanel\",\n                  \"actualiza cyberpanel\",\n            ],\n            templateId: 10,\n            templateType: \"job\",\n      },\n      {\n            id: \"actualizacion-wordpress\",\n            aliases: [\n                  \"actualizacion wordpress\",\n                  \"actualizar wordpress\",\n                  \"mantenimiento wordpress\",\n                  \"actualizar sitios web en wordpress\",\n                  \"wordpress core plugins themes\",\n            ],\n            templateId: 11,\n            templateType: \"job\",\n      },\n      {\n            id: \"mantenimiento-preventivo-web\",\n            aliases: [\n                  \"mantenimiento preventivo servidores web\",\n                  \"mantenimiento preventivo web\",\n                  \"mantenimiento cyberpanel\",\n                  \"mantenimiento servidores web\",\n                  \"ejecutar mantenimiento preventivo\",\n            ],\n            templateId: 9,\n            templateType: \"job\",\n      },\n      {\n            id: \"revision-maquinas-citrix\",\n            aliases: [\n                  \"revision de maquinas en citrix\",\n                  \"revisar maquinas citrix\",\n                  \"workflow citrix\",\n                  \"ejecutar revision citrix\",\n                  \"revision citrix\",\n            ],\n            templateId: 17,\n            templateType: \"workflow\",\n      },\n      {\n            id: \"revision-servidor-agv\",\n            aliases: [\n                  \"revision de servidor agv\",\n                  \"revision servidor agv\",\n                  \"revisar agv\",\n                  \"revisar aguv\",\n                  \"workflow agv\",\n                  \"revision de agvs\",\n            ],\n            templateId: 22,\n            templateType: \"workflow\",\n      },\n];\n"],"names":[],"mappings":";;;;AAQO,MAAM,kBAAoC;IAC3C;QACM,IAAI;QACJ,SAAS;YACH;YACA;YACA;YACA;YACA;SACL;QACD,YAAY;QACZ,cAAc;IACpB;IACA;QACM,IAAI;QACJ,SAAS;YACH;YACA;YACA;YACA;YACA;SACL;QACD,YAAY;QACZ,cAAc;IACpB;IACA;QACM,IAAI;QACJ,SAAS;YACH;YACA;YACA;YACA;YACA;SACL;QACD,YAAY;QACZ,cAAc;IACpB;IACA;QACM,IAAI;QACJ,SAAS;YACH;YACA;YACA;YACA;YACA;SACL;QACD,YAAY;QACZ,cAAc;IACpB;IACA;QACM,IAAI;QACJ,SAAS;YACH;YACA;YACA;YACA;YACA;YACA;SACL;QACD,YAAY;QACZ,cAAc;IACpB;CACL"}},
    {"offset": {"line": 117, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/lib/command-parser.ts"],"sourcesContent":["import { commandMappings, type CommandMapping } from \"@/config/command-mappings\";\n\nfunction normalize(value: string) {\n  return value\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\")\n    .replace(/[^a-z0-9\\s]/g, \" \")\n    .replace(/\\s+/g, \" \")\n    .trim();\n}\n\nfunction tokenOverlapScore(transcript: string, alias: string): number {\n  const transcriptTokens = new Set(normalize(transcript).split(\" \").filter(Boolean));\n  const aliasTokens = normalize(alias).split(\" \").filter(Boolean);\n\n  if (aliasTokens.length === 0) {\n    return 0;\n  }\n\n  const matchedTokens = aliasTokens.filter((token) => transcriptTokens.has(token)).length;\n  return matchedTokens / aliasTokens.length;\n}\n\nexport function getSupportedCommands(): string[] {\n  return commandMappings.map((mapping) => mapping.id);\n}\n\nexport function matchCommand(transcript: string): CommandMapping | null {\n  const normalizedTranscript = normalize(transcript);\n  let best: { mapping: CommandMapping; score: number } | null = null;\n\n  for (const mapping of commandMappings) {\n    const directMatch = mapping.aliases.some((alias) => {\n      const normalizedAlias = normalize(alias);\n      return normalizedAlias.length > 0 && normalizedTranscript.includes(normalizedAlias);\n    });\n\n    if (directMatch) {\n      return mapping;\n    }\n\n    const bestAliasScore = Math.max(\n      ...mapping.aliases.map((alias) => tokenOverlapScore(normalizedTranscript, alias)),\n      0,\n    );\n\n    if (!best || bestAliasScore > best.score) {\n      best = { mapping, score: bestAliasScore };\n    }\n  }\n\n  if (best && best.score >= 0.6) {\n    return best.mapping;\n  }\n\n  return null;\n}\n"],"names":[],"mappings":";;;;;;AAAA;;AAEA,SAAS,UAAU,KAAa;IAC9B,OAAO,MACJ,WAAW,GACX,SAAS,CAAC,OACV,OAAO,CAAC,oBAAoB,IAC5B,OAAO,CAAC,gBAAgB,KACxB,OAAO,CAAC,QAAQ,KAChB,IAAI;AACT;AAEA,SAAS,kBAAkB,UAAkB,EAAE,KAAa;IAC1D,MAAM,mBAAmB,IAAI,IAAI,UAAU,YAAY,KAAK,CAAC,KAAK,MAAM,CAAC;IACzE,MAAM,cAAc,UAAU,OAAO,KAAK,CAAC,KAAK,MAAM,CAAC;IAEvD,IAAI,YAAY,MAAM,KAAK,GAAG;QAC5B,OAAO;IACT;IAEA,MAAM,gBAAgB,YAAY,MAAM,CAAC,CAAC,QAAU,iBAAiB,GAAG,CAAC,QAAQ,MAAM;IACvF,OAAO,gBAAgB,YAAY,MAAM;AAC3C;AAEO,SAAS;IACd,OAAO,yJAAe,CAAC,GAAG,CAAC,CAAC,UAAY,QAAQ,EAAE;AACpD;AAEO,SAAS,aAAa,UAAkB;IAC7C,MAAM,uBAAuB,UAAU;IACvC,IAAI,OAA0D;IAE9D,KAAK,MAAM,WAAW,yJAAe,CAAE;QACrC,MAAM,cAAc,QAAQ,OAAO,CAAC,IAAI,CAAC,CAAC;YACxC,MAAM,kBAAkB,UAAU;YAClC,OAAO,gBAAgB,MAAM,GAAG,KAAK,qBAAqB,QAAQ,CAAC;QACrE;QAEA,IAAI,aAAa;YACf,OAAO;QACT;QAEA,MAAM,iBAAiB,KAAK,GAAG,IAC1B,QAAQ,OAAO,CAAC,GAAG,CAAC,CAAC,QAAU,kBAAkB,sBAAsB,SAC1E;QAGF,IAAI,CAAC,QAAQ,iBAAiB,KAAK,KAAK,EAAE;YACxC,OAAO;gBAAE;gBAAS,OAAO;YAAe;QAC1C;IACF;IAEA,IAAI,QAAQ,KAAK,KAAK,IAAI,KAAK;QAC7B,OAAO,KAAK,OAAO;IACrB;IAEA,OAAO;AACT"}},
    {"offset": {"line": 168, "column": 0}, "map": {"version":3,"sources":["file:///home/alabrador/dashboard-ansible-ia/src/app/api/execute/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\";\nimport { getSupportedCommands, matchCommand } from \"@/lib/command-parser\";\n\nconst whisperUrl = process.env.WHISPER_SERVER_URL ?? \"http://127.0.0.1:5000\";\nconst awxBaseUrl = process.env.AWX_BASE_URL;\nconst awxToken = process.env.AWX_API_TOKEN;\n\ntype AwxLaunchResponse = {\n  id?: number;\n  url?: string;\n  detail?: string;\n  msg?: string;\n  error?: string;\n};\n\nfunction buildAuthHeaders() {\n  if (!awxToken) {\n    return null;\n  }\n\n  return {\n    Authorization: `Bearer ${awxToken}`,\n    \"Content-Type\": \"application/json\",\n  };\n}\n\nfunction extractTemplateId(transcript: string): number | null {\n  const normalized = transcript\n    .toLowerCase()\n    .normalize(\"NFD\")\n    .replace(/[\\u0300-\\u036f]/g, \"\");\n\n  const match = normalized.match(/(?:template|plantilla)\\s*(?:id\\s*)?(\\d{1,8})/i);\n  if (!match) {\n    return null;\n  }\n\n  const parsed = Number(match[1]);\n  return Number.isInteger(parsed) && parsed > 0 ? parsed : null;\n}\n\nfunction extractAwxErrorDetail(payload: unknown): string | null {\n  if (!payload || typeof payload !== \"object\") {\n    return null;\n  }\n\n  const data = payload as Record<string, unknown>;\n  const candidates = [data.detail, data.msg, data.error, data.non_field_errors];\n\n  for (const item of candidates) {\n    if (typeof item === \"string\" && item.trim()) {\n      return item;\n    }\n\n    if (Array.isArray(item) && item.length > 0 && typeof item[0] === \"string\") {\n      return item[0];\n    }\n  }\n\n  for (const [key, value] of Object.entries(data)) {\n    if (typeof value === \"string\" && value.trim()) {\n      return `${key}: ${value}`;\n    }\n\n    if (Array.isArray(value) && value.length > 0 && typeof value[0] === \"string\") {\n      return `${key}: ${value[0]}`;\n    }\n  }\n\n  return null;\n}\n\nexport async function POST(request: Request) {\n  try {\n    if (!awxBaseUrl || !awxToken) {\n      return NextResponse.json(\n        {\n          error:\n            \"Faltan variables AWX_BASE_URL o AWX_API_TOKEN. Revisa el archivo .env.local.\",\n        },\n        { status: 500 },\n      );\n    }\n\n    const inputForm = await request.formData();\n    const audioFile = inputForm.get(\"audio\");\n\n    if (!(audioFile instanceof File)) {\n      return NextResponse.json(\n        { error: \"No se recibió audio para procesar.\" },\n        { status: 400 },\n      );\n    }\n\n    const whisperForm = new FormData();\n    whisperForm.append(\"audio\", audioFile, audioFile.name || \"voice-command.webm\");\n\n    const transcriptionResponse = await fetch(`${whisperUrl}/transcribe`, {\n      method: \"POST\",\n      body: whisperForm,\n    });\n\n    const transcriptionData = (await transcriptionResponse.json()) as {\n      text?: string;\n      error?: string;\n    };\n\n    if (!transcriptionResponse.ok) {\n      return NextResponse.json(\n        { error: transcriptionData.error ?? \"Error transcribiendo audio.\" },\n        { status: transcriptionResponse.status },\n      );\n    }\n\n    const transcript = (transcriptionData.text ?? \"\").trim();\n    if (!transcript) {\n      return NextResponse.json(\n        { error: \"No se detectó texto en el audio.\" },\n        { status: 422 },\n      );\n    }\n\n    const directTemplateId = extractTemplateId(transcript);\n    const matched = directTemplateId\n      ? {\n          id: `template-${directTemplateId}`,\n          aliases: [],\n          templateId: directTemplateId,\n          templateType: \"job\" as const,\n        }\n      : matchCommand(transcript);\n\n    if (!matched) {\n      return NextResponse.json(\n        {\n          error: \"No se encontró un comando compatible con la voz detectada.\",\n          transcript,\n          supportedCommands: getSupportedCommands(),\n        },\n        { status: 422 },\n      );\n    }\n\n    const headers = buildAuthHeaders();\n    if (!headers) {\n      return NextResponse.json(\n        { error: \"No se pudo construir autenticación para AWX.\" },\n        { status: 500 },\n      );\n    }\n\n    const baseUrl = awxBaseUrl.replace(/\\/$/, \"\");\n    const launchPath =\n      matched.templateType === \"workflow\"\n        ? `/api/v2/workflow_job_templates/${matched.templateId}/launch/`\n        : `/api/v2/job_templates/${matched.templateId}/launch/`;\n    const launchUrl = `${baseUrl}${launchPath}`;\n    const launchPayload =\n      matched.templateType === \"workflow\"\n        ? {}\n        : {\n            extra_vars: {\n              source: \"voice-command\",\n              transcript,\n              ...(matched.extraVars ?? {}),\n            },\n          };\n\n    let launchResponse: Response;\n    try {\n      launchResponse = await fetch(launchUrl, {\n        method: \"POST\",\n        headers,\n        body: JSON.stringify(launchPayload),\n        signal: AbortSignal.timeout(15000),\n      });\n    } catch (launchError) {\n      const detail =\n        launchError instanceof Error\n          ? launchError.message\n          : \"No fue posible conectar con AWX.\";\n\n      return NextResponse.json(\n        {\n          error: `Fallo de conexión con AWX: ${detail}`,\n          transcript,\n          matchedCommand: matched.id,\n          templateId: matched.templateId,\n        },\n        { status: 502 },\n      );\n    }\n\n    const launchRaw = await launchResponse.text();\n    let launchData: AwxLaunchResponse = {};\n    let launchResponsePayload: unknown = launchRaw;\n\n    try {\n      launchResponsePayload = JSON.parse(launchRaw);\n      launchData = launchResponsePayload as AwxLaunchResponse;\n    } catch {\n      launchResponsePayload = launchRaw;\n    }\n\n    if (!launchResponse.ok || !launchData.id) {\n      const awxDetail = extractAwxErrorDetail(launchResponsePayload);\n      const fallbackBody =\n        typeof launchResponsePayload === \"string\" && launchResponsePayload.trim()\n          ? launchResponsePayload.slice(0, 300)\n          : \"Sin detalle\";\n\n      return NextResponse.json(\n        {\n          error: `AWX rechazó la ejecución del template (HTTP ${launchResponse.status}). ${awxDetail ?? fallbackBody}`,\n          transcript,\n          matchedCommand: matched.id,\n          templateId: matched.templateId,\n        },\n        { status: launchResponse.status || 500 },\n      );\n    }\n\n    return NextResponse.json({\n      transcript,\n      matchedCommand: matched.id,\n      templateId: matched.templateId,\n      templateType: matched.templateType,\n      jobId: launchData.id,\n      awxUrl:\n        matched.templateType === \"workflow\"\n          ? `${baseUrl}/#/jobs/workflow/${launchData.id}`\n          : `${baseUrl}/#/jobs/playbook/${launchData.id}`,\n    });\n  } catch (error) {\n    const detail = error instanceof Error ? error.message : \"Error inesperado\";\n    return NextResponse.json(\n      { error: `No se pudo ejecutar el flujo de voz a AWX. ${detail}` },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}