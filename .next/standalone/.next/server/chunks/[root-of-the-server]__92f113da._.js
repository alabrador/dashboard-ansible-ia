module.exports=[57328,(e,t,r)=>{t.exports=e.x("node:assert",()=>require("node:assert"))},61095,(e,t,r)=>{t.exports=e.x("node:net",()=>require("node:net"))},85560,(e,t,r)=>{t.exports=e.x("node:tls",()=>require("node:tls"))},87769,(e,t,r)=>{t.exports=e.x("node:events",()=>require("node:events"))},30450,e=>{"use strict";var t,r=e.i(47909),s=e.i(74017),i=e.i(96250),n=e.i(59756),a=e.i(61916),o=e.i(74677),c=e.i(69741),l=e.i(16795),u=e.i(87718),h=e.i(95169),d=e.i(47587),p=e.i(66012),f=e.i(70101),g=e.i(26937),w=e.i(10372),m=e.i(93695);e.i(52474);var b=e.i(220),y=e.i(89171),S=e.i(76661);async function v(e,t){let r=e.trim().toLowerCase(),s=!1;try{s=await (0,S.verifyStoredLocalUser)(r,t)}catch{s=!1}if(!s){let e,s=(!(e=process.env.LOCAL_AUTH_USERS??"").trim()?[]:e.split(";").map(e=>e.trim()).filter(Boolean).map(e=>{let t=e.indexOf(":");if(t<=0)return null;let r=e.slice(0,t).trim().toLowerCase(),s=e.slice(t+1).trim();return r&&s?{email:r,password:s}:null}).filter(e=>null!==e)).find(e=>e.email===r);if(!s||s.password!==t)return{ok:!1,error:"Credenciales locales inv√°lidas."}}return{ok:!0,user:{email:r,source:"local"}}}var O=e.i(57328),x=e.i(12057),E=e.i(66680),k=e.i(61095),A=e.i(85560),L=e.i(87769);class M extends Error{constructor(e){super(e),this.name="InvalidAsn1Error"}}class R{size;currentLength=0;currentOffset=0;buffer;constructor(e){if(!Buffer.isBuffer(e))throw TypeError("data must be a Buffer");this.buffer=e,this.size=e.length}get length(){return this.currentLength}get offset(){return this.currentOffset}set offset(e){this.currentOffset=e}get remain(){return this.size-this.currentOffset}get remainingBuffer(){return this.buffer.subarray(this.currentOffset)}setBufferSize(e){this.size=e}readByte(e=!1){if(this.size-this.currentOffset<1)return null;let t=this.buffer.readUInt8(this.currentOffset);return e||(this.currentOffset+=1),t}peek(){return this.readByte(!0)}readLength(e){let t=e??this.currentOffset;if(t>=this.size)return null;let r=this.buffer.readUInt8(t);if(t+=1,(128&r)==128){let e=127&r;if(0===e)throw new M("Indefinite length not supported");if(e>4)throw new M("Encoding too long");if(this.size-t<e)return null;this.currentLength=0;for(let r=0;r<e;r++)this.currentLength=(this.currentLength<<8)+this.buffer.readUInt8(t),t+=1}else this.currentLength=r;return t}readSequence(e){let t=this.peek();if(null===t)return null;if(void 0!==e&&e!==t)throw new M(`Expected 0x${e.toString(16)}: got 0x${t.toString(16)}`);let r=this.readLength(this.currentOffset+1);return null===r?null:(this.currentOffset=r,t)}readInt(){return this.readTag(2)}readBoolean(){let e=this.readTag(1);return null===e?null:0!==e}readEnumeration(){return this.readTag(10)}readString(e=4,t=!1){let r=this.peek();if(null===r)return null;if(r!==e)throw new M(`Expected 0x${e.toString(16)}: got 0x${r.toString(16)}`);let s=this.readLength(this.currentOffset+1);if(null===s||this.currentLength>this.size-s)return null;if(this.currentOffset=s,0===this.currentLength)return t?Buffer.alloc(0):"";let i=this.buffer.subarray(this.currentOffset,this.currentOffset+this.currentLength);return this.currentOffset+=this.currentLength,t?i:i.toString("utf8")}readOID(e=6){let t=this.readString(e,!0);if(null===t)return null;let r=[],s=0;for(let e of t)s=(s<<7)+(127&e),(128&e)==0&&(r.push(s),s=0);let i=r[0]??0;return[Math.trunc(i/40),i%40,...r.slice(1)].join(".")}readTag(e){let t=this.peek();if(null===t)return null;if(t!==e)throw new M(`Expected 0x${e.toString(16)}: got 0x${t.toString(16)}`);let r=this.readLength(this.currentOffset+1);if(null===r)return null;if(this.currentLength>4)throw new M(`Integer too long: ${this.currentLength}`);if(this.currentLength>this.size-r)return null;this.currentOffset=r;let s=this.buffer.readUInt8(this.currentOffset),i=0;for(let e=0;e<this.currentLength;e++)i=i<<8|this.buffer.readUInt8(this.currentOffset),this.currentOffset+=1;return(128&s)==128&&this.currentLength<4&&(i-=1<<8*this.currentLength),0|i}}class C{data;size;currentOffset=0;growthFactor;sequenceOffsets=[];constructor(e={}){const t=e.size??1024;this.growthFactor=e.growthFactor??8,this.data=Buffer.alloc(t),this.size=t}get buffer(){if(this.sequenceOffsets.length>0)throw new M(`${this.sequenceOffsets.length} unended sequence(s)`);return this.data.subarray(0,this.currentOffset)}writeByte(e){this.ensureCapacity(1),this.data[this.currentOffset++]=e}writeInt(e,t=2){let r=e,s=4;for(;((0xff800000&r)==0||(0xff800000&r)==-8388608)&&s>1;)s--,r<<=8;if(s>4)throw new M("BER integers cannot be > 0xffffffff");for(this.ensureCapacity(2+s),this.data[this.currentOffset++]=t,this.data[this.currentOffset++]=s;s>0;)s--,this.data[this.currentOffset++]=(0xff000000&r)>>>24,r<<=8}writeNull(){this.writeByte(5),this.writeByte(0)}writeEnumeration(e,t=10){this.writeInt(e,t)}writeBoolean(e,t=1){this.ensureCapacity(3),this.data[this.currentOffset++]=t,this.data[this.currentOffset++]=1,this.data[this.currentOffset++]=255*!!e}writeString(e,t=4){let r=Buffer.byteLength(e);this.writeByte(t),this.writeLength(r),r>0&&(this.ensureCapacity(r),this.data.write(e,this.currentOffset),this.currentOffset+=r)}writeBuffer(e,t){this.writeByte(t),this.writeLength(e.length),this.ensureCapacity(e.length),e.copy(this.data,this.currentOffset,0,e.length),this.currentOffset+=e.length}writeStringArray(e){for(let t of e)this.writeString(t)}writeOID(e,t=6){if(!/^(\d+\.){3,}\d+$/.test(e))throw Error("Argument is not a valid OID string");let r=e.split("."),s=[],i=r[0]??"0",n=r[1]??"0";for(let e of(s.push(40*Number(i)+Number(n)),r.slice(2)))this.encodeOidOctet(s,Number(e));for(let e of(this.ensureCapacity(2+s.length),this.writeByte(t),this.writeLength(s.length),s))this.writeByte(e)}writeLength(e){if(this.ensureCapacity(4),e<=127)this.data[this.currentOffset++]=e;else if(e<=255)this.data[this.currentOffset++]=129,this.data[this.currentOffset++]=e;else if(e<=65535)this.data[this.currentOffset++]=130,this.data[this.currentOffset++]=e>>8,this.data[this.currentOffset++]=e;else if(e<=0xffffff)this.data[this.currentOffset++]=131,this.data[this.currentOffset++]=e>>16,this.data[this.currentOffset++]=e>>8,this.data[this.currentOffset++]=e;else throw new M("Length too long (> 4 bytes)")}startSequence(e=48){this.writeByte(e),this.sequenceOffsets.push(this.currentOffset),this.ensureCapacity(3),this.currentOffset+=3}endSequence(){let e=this.sequenceOffsets.pop();if(void 0===e)throw new M("No sequence to end");let t=e+3,r=this.currentOffset-t;if(r<=127)this.shiftContent(t,r,-2),this.data[e]=r;else if(r<=255)this.shiftContent(t,r,-1),this.data[e]=129,this.data[e+1]=r;else if(r<=65535)this.data[e]=130,this.data[e+1]=r>>8,this.data[e+2]=r;else if(r<=0xffffff)this.shiftContent(t,r,1),this.data[e]=131,this.data[e+1]=r>>16,this.data[e+2]=r>>8,this.data[e+3]=r;else throw new M("Sequence too long")}encodeOidOctet(e,t){t<128?e.push(t):(t<16384?e.push(t>>>7|128):(t<2097152?e.push(t>>>14|128):(t<0x10000000?e.push(t>>>21|128):(e.push((t>>>28|128)&255),e.push((t>>>21|128)&255)),e.push((t>>>14|128)&255)),e.push((t>>>7|128)&255)),e.push(127&t))}shiftContent(e,t,r){this.data.copy(this.data,e+r,e,e+t),this.currentOffset+=r}ensureCapacity(e){if(this.size-this.currentOffset<e){let t=this.size*this.growthFactor;t-this.currentOffset<e&&(t+=e);let r=Buffer.alloc(t);this.data.copy(r,0,0,this.currentOffset),this.data=r,this.size=t}}}class I{type;critical;constructor(e,t={}){this.type=e,this.critical=!0===t.critical}write(e){e.startSequence(),e.writeString(this.type),e.writeBoolean(this.critical),this.writeControl(e),e.endSequence()}parse(e){this.parseControl(e)}writeControl(e){}parseControl(e){}}class T extends I{static type="2.16.840.1.113730.3.4.7";value;constructor(e={}){super(T.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t,r=e.readInt()??0;8===r&&(t=e.readString());let s=e.readInt()??0;this.value={changeType:r,previousDN:t,changeNumber:s}}}writeControl(e){if(!this.value)return;let t=new C;t.startSequence(),t.writeInt(this.value.changeType),this.value.previousDN&&t.writeString(this.value.previousDN),t.writeInt(this.value.changeNumber),t.endSequence(),e.writeBuffer(t.buffer,4)}}class _ extends I{static type="1.2.840.113556.1.4.319";value;constructor(e={}){super(_.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t=e.readInt()??0,r=e.readString(4,!0)??Buffer.alloc(0);this.value={size:t,cookie:r}}}writeControl(e){if(!this.value)return;let t=new C;t.startSequence(),t.writeInt(this.value.size),this.value.cookie?.length?t.writeBuffer(this.value.cookie,4):t.writeString(""),t.endSequence(),e.writeBuffer(t.buffer,4)}}class q extends I{static type="2.16.840.1.113730.3.4.3";value;constructor(e={}){super(q.type,e),this.value=e.value}parseControl(e){if(e.readSequence()){let t=e.readInt()??0,r=e.readBoolean()??!1,s=e.readBoolean()??!1;this.value={changeTypes:t,changesOnly:r,returnECs:s}}}writeControl(e){if(!this.value)return;let t=new C;t.startSequence(),t.writeInt(this.value.changeTypes),t.writeBoolean(this.value.changesOnly),t.writeBoolean(this.value.returnECs),t.endSequence(),e.writeBuffer(t.buffer,4)}}class P extends I{static type="1.2.840.113556.1.4.473";values;constructor(e={}){super(P.type,e),Array.isArray(e.value)?this.values=e.value:"object"==typeof e.value?this.values=[e.value]:this.values=[]}parseControl(e){if(e.readSequence(48))for(;e.readSequence(48);){let t=e.readString()??"",r="",s=!1;128===e.peek()&&(r=e.readString(128)??""),129===e.peek()&&(s=0!==e.readTag(129)),this.values.push({attributeType:t,orderingRule:r,reverseOrder:s})}}writeControl(e){if(!this.values.length)return;let t=new C;for(let e of(t.startSequence(48),this.values))t.startSequence(48),t.writeString(e.attributeType,4),e.orderingRule&&t.writeString(e.orderingRule,128),void 0!==e.reverseOrder&&t.writeBoolean(e.reverseOrder,129),t.endSequence();t.endSequence(),e.writeBuffer(t.buffer,4)}}class B extends Error{messageDetails;constructor(e){super(e),this.name="MessageParserError",Object.setPrototypeOf(this,B.prototype)}}class D extends Error{code;constructor(e,t){super(`${t} Code: 0x${e.toString(16)}`),this.name="ResultCodeError",this.code=e,Object.setPrototypeOf(this,D.prototype)}}class j extends D{constructor(e){super(11,e??"An LDAP server limit set by an administrative authority has been exceeded."),this.name="AdminLimitExceededError",Object.setPrototypeOf(this,j.prototype)}}class $ extends D{constructor(e){super(71,e??"The modify DN operation moves the entry from one LDAP server to another and thus requires more than one LDAP server."),this.name="AffectsMultipleDSAsError",Object.setPrototypeOf(this,$.prototype)}}class N extends D{constructor(e){super(36,e??"Either the client does not have access rights to read the aliased object's name or dereferencing is not allowed."),this.name="AliasDerefProblemError",Object.setPrototypeOf(this,N.prototype)}}class F extends D{constructor(e){super(33,e??"An error occurred when an alias was dereferenced."),this.name="AliasProblemError",Object.setPrototypeOf(this,F.prototype)}}class U extends D{constructor(e){super(68,e??"The add operation attempted to add an entry that already exists, or that the modify operation attempted to rename an entry to the name of an entry that already exists."),this.name="AlreadyExistsError",Object.setPrototypeOf(this,U.prototype)}}class z extends D{constructor(e){super(7,e??"The Directory Server does not support the requested Authentication Method."),this.name="AuthMethodNotSupportedError",Object.setPrototypeOf(this,z.prototype)}}class H extends D{constructor(e){super(51,e??"The LDAP server is too busy to process the client request at this time."),this.name="BusyError",Object.setPrototypeOf(this,H.prototype)}}class V extends D{constructor(e){super(13,e??"The session is not protected by a protocol such as Transport Layer Security (TLS), which provides session confidentiality and the request will not be handled without confidentiality enabled."),this.name="ConfidentialityRequiredError",Object.setPrototypeOf(this,V.prototype)}}class W extends D{constructor(e){super(19,e??"The attribute value specified in a Add Request, Modify Request or ModifyDNRequest operation violates constraints placed on the attribute. The constraint can be one of size or content (string only, no binary)."),this.name="ConstraintViolationError",Object.setPrototypeOf(this,W.prototype)}}class K extends D{constructor(e){super(48,e??"The client is attempting to use an authentication method incorrectly."),this.name="InappropriateAuthError",Object.setPrototypeOf(this,K.prototype)}}class J extends D{constructor(e){super(18,e??"The matching rule specified in the search filter does not match a rule defined for the attribute's syntax."),this.name="InappropriateMatchingError",Object.setPrototypeOf(this,J.prototype)}}class G extends D{constructor(e){super(50,e??"The caller does not have sufficient rights to perform the requested operation."),this.name="InsufficientAccessError",Object.setPrototypeOf(this,G.prototype)}}class X extends D{constructor(e){super(49,e??"Invalid credentials during a bind operation."),this.name="InvalidCredentialsError",Object.setPrototypeOf(this,X.prototype)}}class Z extends D{constructor(e){super(34,e??"The syntax of the DN is incorrect."),this.name="InvalidDNSyntaxError",Object.setPrototypeOf(this,Z.prototype)}}class Q extends D{constructor(e){super(21,e??"The attribute value specified in an Add Request, Compare Request, or Modify Request operation is an unrecognized or invalid syntax for the attribute."),this.name="InvalidSyntaxError",Object.setPrototypeOf(this,Q.prototype)}}class Y extends D{constructor(e){super(35,e??"The specified operation cannot be performed on a leaf entry."),this.name="IsLeafError",Object.setPrototypeOf(this,Y.prototype)}}class ee extends D{constructor(e){super(54,e??"The client discovered an alias or LDAP Referral loop, and is thus unable to complete this request."),this.name="LoopDetectError",Object.setPrototypeOf(this,ee.prototype)}}class et extends D{constructor(e){super(95,e),this.name="MoreResultsToReturnError",Object.setPrototypeOf(this,et.prototype)}}class er extends D{constructor(e){super(64,e??"The Add Request or Modify DN Request operation violates the schema's structure rules."),this.name="NamingViolationError",Object.setPrototypeOf(this,er.prototype)}}class es extends D{constructor(e){super(69,e??"The modify operation attempted to modify the structure rules of an object class."),this.name="NoObjectClassModsError",Object.setPrototypeOf(this,es.prototype)}}class ei extends D{constructor(e){super(16,e??"The attribute specified in the Modify Request or Compare Request operation does not exist in the entry."),this.name="NoSuchAttributeError",Object.setPrototypeOf(this,ei.prototype)}}class en extends D{constructor(e){super(32,e??"The target object cannot be found."),this.name="NoSuchObjectError",Object.setPrototypeOf(this,en.prototype)}}class ea extends D{constructor(e){super(66,e??"The requested operation is permitted only on leaf entries."),this.name="NotAllowedOnNonLeafError",Object.setPrototypeOf(this,ea.prototype)}}class eo extends D{constructor(e){super(67,e??"The modify operation attempted to remove an attribute value that forms the entry's relative distinguished name."),this.name="NotAllowedOnRDNError",Object.setPrototypeOf(this,eo.prototype)}}class ec extends D{constructor(e){super(248,e??"No result message for the request."),this.name="NoResultError",Object.setPrototypeOf(this,ec.prototype)}}class el extends D{constructor(e){super(65,e??"The Add Request, Modify Request, or modify DN operation violates the object class rules for the entry."),this.name="ObjectClassViolationError",Object.setPrototypeOf(this,el.prototype)}}class eu extends D{constructor(e){super(1,e??"Request was out of sequence with another operation in progress."),this.name="OperationsError",Object.setPrototypeOf(this,eu.prototype)}}class eh extends D{constructor(e){super(2,e??"Client sent data to the server that did not comprise a valid LDAP request."),this.name="ProtocolError",Object.setPrototypeOf(this,eh.prototype)}}class ed extends D{constructor(e){super(70,e??"Results are too large."),this.name="ResultsTooLargeError",Object.setPrototypeOf(this,ed.prototype)}}class ep extends D{response;constructor(e){super(14,e.errorMessage||"The server is ready for the next step in the SASL authentication process. The client must send the server the same SASL Mechanism to continue the process."),this.response=e,this.name="SaslBindInProgressError",Object.setPrototypeOf(this,ep.prototype)}}class ef extends D{constructor(e){super(4,e??"There were more entries matching the criteria contained in a SearchRequest operation than were allowed to be returned by the size limit configuration."),this.name="SizeLimitExceededError",Object.setPrototypeOf(this,ef.prototype)}}class eg extends D{constructor(e){super(8,e??"Client requested an operation that requires strong authentication."),this.name="StrongAuthRequiredError",Object.setPrototypeOf(this,eg.prototype)}}class ew extends D{constructor(e){super(3,e??"Processing on the associated request Timeout limit specified by either the client request or the server administration limits has been exceeded and has been terminated because it took too long to complete."),this.name="TimeLimitExceededError",Object.setPrototypeOf(this,ew.prototype)}}class em extends D{constructor(e){super(112,e??"TLS is not supported on the server."),this.name="TLSNotSupportedError",Object.setPrototypeOf(this,em.prototype)}}class eb extends D{constructor(e){super(20,e??"The attribute value specified in a Add Request or Modify Request operation already exists as a value for that attribute."),this.name="TypeOrValueExistsError",Object.setPrototypeOf(this,eb.prototype)}}class ey extends D{constructor(e){super(12,e??"One or more critical extensions were not available by the LDAP server. Either the server does not support the control or the control is not appropriate for the operation type."),this.name="UnavailableCriticalExtensionError",Object.setPrototypeOf(this,ey.prototype)}}class eS extends D{constructor(e){super(52,e??"The LDAP server cannot process the client's bind request."),this.name="UnavailableError",Object.setPrototypeOf(this,eS.prototype)}}class ev extends D{constructor(e){super(17,e??"The attribute specified in the modify or add operation does not exist in the LDAP server's schema."),this.name="UndefinedTypeError",Object.setPrototypeOf(this,ev.prototype)}}class eO extends D{constructor(e,t){super(e,t??"Unknown error."),this.name="UnknownStatusCodeError",Object.setPrototypeOf(this,eO.prototype)}}class ex extends D{constructor(e){super(53,e??"The LDAP server cannot process the request because of server-defined restrictions."),this.name="UnwillingToPerformError",Object.setPrototypeOf(this,ex.prototype)}}class eE{write(e){e.startSequence(this.type),this.writeFilter(e),e.endSequence()}parse(e){this.parseFilter(e)}matches(e={},t){return!0}escape(e){let t="";if(Buffer.isBuffer(e))for(let r of e)r<16?t+=`\\0${r.toString(16)}`:t+=`\\${r.toString(16)}`;else for(let r of e)switch(r){case"*":t+="\\2a";break;case"(":t+="\\28";break;case")":t+="\\29";break;case"\\":t+="\\5c";break;case"\0":t+="\\00";break;default:t+=r}return t}parseFilter(e){}writeFilter(e){}getObjectValue(e,t,r){let s;if(void 0!==e[t])s=t;else if(!r&&"objectclass"===t.toLowerCase()){for(let r of Object.keys(e))if(r.toLowerCase()===t.toLowerCase()){s=r;break}}if(s)return e[s]}}class ek extends eE{type=160;filters;constructor(e){super(),this.filters=e.filters}writeFilter(e){for(let t of this.filters)t.write(e)}matches(e={},t){if(!this.filters.length)return!0;for(let r of this.filters)if(!r.matches(e,t))return!1;return!0}toString(){let e="(&";for(let t of this.filters)e+=t.toString();return e+")"}}class eA extends eE{type=168;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){throw Error("Approximate match implementation unknown")}toString(){return`(${this.escape(this.attribute)}~=${this.escape(this.value)})`}}class eL extends eE{type=163;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??"","objectclass"===this.attribute&&(this.value=this.value.toLowerCase())}writeFilter(e){e.writeString(this.attribute),Buffer.isBuffer(this.value)?e.writeBuffer(this.value,4):e.writeString(this.value)}matches(e={},t){let r=this.getObjectValue(e,this.attribute,t);if(void 0!==r){if(Buffer.isBuffer(this.value)&&Buffer.isBuffer(r))return this.value===r;let e=Buffer.isBuffer(this.value)?this.value.toString("utf8"):this.value;return t?e===r:e.toLowerCase()===r.toLowerCase()}return!1}toString(){return`(${this.escape(this.attribute)}=${this.escape(this.value)})`}}class eM extends eE{type=169;value;rule;matchType;dnAttributes;constructor(e={}){super(),this.matchType=e.matchType??"",this.rule=e.rule??"",this.dnAttributes=!0===e.dnAttributes,this.value=e.value??""}parseFilter(e){let t=e.offset+e.length;for(;e.offset<t;){let t=e.peek();switch(t){case 129:this.rule=e.readString(t)??"";break;case 130:this.matchType=e.readString(t)??"";break;case 131:this.value=e.readString(t)??"";break;case 132:this.dnAttributes=e.readBoolean()??!1;break;default:{let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Invalid ext_match filter type: ${e}`)}}}}writeFilter(e){this.rule&&e.writeString(this.rule,129),this.matchType&&e.writeString(this.matchType,130),e.writeString(this.value,131),this.dnAttributes&&e.writeBoolean(this.dnAttributes,132)}matches(e={},t){throw Error("Approximate match implementation unknown")}toString(){let e=`(${this.escape(this.matchType)}:`;return this.dnAttributes&&(e+="dn:"),this.rule&&(e+=`${this.escape(this.rule)}:`),e+=`=${this.escape(this.value)})`}}class eR extends eE{type=165;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){let r=this.getObjectValue(e,this.attribute,t);return void 0!==r&&(t?r>=this.value:r.toLowerCase()>=this.value.toLowerCase())}toString(){return`(${this.escape(this.attribute)}>=${this.escape(this.value)})`}}class eC extends eE{type=166;attribute;value;constructor(e={}){super(),this.attribute=e.attribute??"",this.value=e.value??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",this.value=e.readString()??""}writeFilter(e){e.writeString(this.attribute),e.writeString(this.value)}matches(e={},t){let r=this.getObjectValue(e,this.attribute,t);return void 0!==r&&(t?r<=this.value:r.toLowerCase()<=this.value.toLowerCase())}toString(){return`(${this.escape(this.attribute)}<=${this.escape(this.value)})`}}class eI extends eE{type=162;filter;constructor(e){super(),this.filter=e.filter}writeFilter(e){this.filter.write(e)}matches(e={},t){return!this.filter.matches(e,t)}toString(){return`(!${this.filter.toString()})`}}class eT extends eE{type=161;filters;constructor(e){super(),this.filters=e.filters}writeFilter(e){for(let t of this.filters)t.write(e)}matches(e={},t){if(!this.filters.length)return!0;for(let r of this.filters)if(r.matches(e,t))return!0;return!1}toString(){let e="(|";for(let t of this.filters)e+=t.toString();return e+")"}}class e_ extends eE{type=135;attribute;constructor(e={}){super(),this.attribute=e.attribute??""}parseFilter(e){this.attribute=e.buffer.subarray(0,e.length).toString("utf8").toLowerCase(),e.offset+=e.length}writeFilter(e){for(let t=0;t<this.attribute.length;t+=1)e.writeByte(this.attribute.charCodeAt(t))}matches(e={},t){return void 0!==this.getObjectValue(e,this.attribute,t)}toString(){return`(${this.escape(this.attribute)}=*)`}}class eq extends eE{type=164;attribute;initial;any;final;constructor(e={}){super(),this.attribute=e.attribute??"",this.initial=e.initial??"",this.any=e.any??[],this.final=e.final??""}parseFilter(e){this.attribute=e.readString()?.toLowerCase()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=e.peek();switch(t){case 128:this.initial=e.readString(t)??"","objectclass"===this.attribute&&(this.initial=this.initial.toLowerCase());break;case 129:{let r=e.readString(t)??"";"objectclass"===this.attribute&&(r=r.toLowerCase()),this.any.push(r);break}case 130:this.final=e.readString(t)??"","objectclass"===this.attribute&&(this.final=this.final.toLowerCase());break;default:{let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Invalid substring filter type: ${e}`)}}}}writeFilter(e){for(let t of(e.writeString(this.attribute),e.startSequence(),this.initial&&e.writeString(this.initial,128),this.any))e.writeString(t,129);this.final&&e.writeString(this.final,130),e.endSequence()}matches(e={},t){let r=this.getObjectValue(e,this.attribute,t);if(void 0!==r){let e="";for(let t of(this.initial&&(e+=`^${eq._escapeRegExp(this.initial)}.*`),this.any))e+=`${eq._escapeRegExp(t)}.*`;return this.final&&(e+=`${eq._escapeRegExp(this.final)}$`),new RegExp(e,t?"gmu":"igmu").test(r)}return!1}toString(){let e=`(${this.escape(this.attribute)}=${this.escape(this.initial)}*`;for(let t of this.any)e+=`${this.escape(t)}*`;return e+`${this.escape(this.final)})`}static _escapeRegExp(e){return e.replace(/[$()*+./?[\\\]^{|}-]/g,"\\$&")}}class eP{static parse(e,t){let r;if(null===e.readSequence())return null;let s="",i=!1,n=Buffer.alloc(0);if(e.length){let t=e.offset+e.length;s=e.readString()??"",e.offset<t&&1===e.peek()&&(i=e.readBoolean()??!1),e.offset<t&&(n=e.readString(4,!0)??Buffer.alloc(0))}switch(s){case T.type:r=new T({critical:i});break;case _.type:r=new _({critical:i});break;case q.type:r=new q({critical:i});break;case P.type:r=new P({critical:i});break;default:r=t.find(e=>e.type===s)}if(!r)return null;let a=new R(n);return r.parse(a),r}}class eB{version=3;messageId=0;controls;constructor(e){this.messageId=e.messageId,this.controls=e.controls}write(){let e=new C;if(e.startSequence(),e.writeInt(this.messageId),e.startSequence(this.protocolOperation),this.writeMessage(e),e.endSequence(),this.controls?.length){for(let t of(e.startSequence(160),this.controls))t.write(e);e.endSequence()}return e.endSequence(),e.buffer}parse(e,t){if(this.controls=[],this.parseMessage(e),160===e.peek()){e.readSequence();let r=e.offset+e.length;for(;e.offset<r;){let r=eP.parse(e,t);r&&this.controls.push(r)}}}toString(){return JSON.stringify({messageId:this.messageId,messageType:this.constructor.name},null,2)}parseMessage(e){}writeMessage(e){}}class eD extends eB{protocolOperation;abandonId;constructor(e){super(e),this.protocolOperation=80,this.abandonId=e.abandonId??0}writeMessage(e){let t=this.abandonId,r=4;for(;((0xff800000&t)==0||(0xff800000&t)==0xff800000)&&r>1;)r-=1,t<<=8;for(O.ok(r<=4);r-- >0;)e.writeByte((0xff000000&t)>>24),t<<=8}parseMessage(e){let{length:t}=e;if(t){let r,s=1,i=e.buffer[s]??0;r=127&i;for(let i=1;i<t;i+=1)r<<=8,s+=1,r|=255&(e.buffer[s]??0);(128&i)==128&&(r=-r),e.offset+=t,this.abandonId=r}else this.abandonId=0}}let ej=new x.TextDecoder("utf8",{fatal:!0});class e${buffers=[];type;values;constructor(e={}){this.type=e.type??"",this.values=e.values??[]}get parsedBuffers(){return this.buffers}write(e){e.startSequence();let{type:t}=this;if(e.writeString(t),e.startSequence(49),this.values.length)for(let t of this.values)Buffer.isBuffer(t)?e.writeBuffer(t,4):e.writeString(t);else e.writeStringArray([]);e.endSequence(),e.endSequence()}parse(e){e.readSequence(),this.type=e.readString()??"";let t=this._isBinaryType();if(49===e.peek()&&e.readSequence(49)){let r=e.offset+e.length;for(;e.offset<r;){let r=e.readString(4,!0)??Buffer.alloc(0);if(this.buffers.push(r),t)this.values.push(r);else try{let e=ej.decode(r);this.values.push(e)}catch{this.values.push(r)}}}}_isBinaryType(){return/;binary$/i.test(this.type||"")}}class eN extends eB{protocolOperation;dn;attributes;constructor(e){super(e),this.protocolOperation=104,this.dn=e.dn,this.attributes=e.attributes??[]}writeMessage(e){for(let t of(e.writeString(this.dn),e.startSequence(),this.attributes))t.write(e);e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new e$;t.parse(e),this.attributes.push(t)}}}class eF extends eB{status;matchedDN;errorMessage;constructor(e){super(e),this.status=e.status??0,this.matchedDN=e.matchedDN??"",this.errorMessage=e.errorMessage??""}parseMessage(e){this.status=e.readEnumeration()??0,this.matchedDN=e.readString()??"",this.errorMessage=e.readString()??""}}class eU extends eF{protocolOperation;constructor(e){super(e),this.protocolOperation=105}}let ez=["EXTERNAL","PLAIN","DIGEST-MD5","SCRAM-SHA-1"];class eH extends eB{protocolOperation;dn;password;mechanism;constructor(e){super(e),this.protocolOperation=96,this.dn=e.dn??"",this.password=e.password??"",this.mechanism=e.mechanism}writeMessage(e){e.writeInt(this.version),e.writeString(this.dn),this.mechanism?(e.startSequence(163),e.writeString(this.mechanism),e.writeString(this.password),e.endSequence()):e.writeString(this.password,128)}parseMessage(e){this.version=e.readInt()??3,this.dn=e.readString()??"";let t=e.peek();if(128!==t){let e="<null>";throw t&&(e=`0x${t.toString(16)}`),Error(`Authentication type not supported: ${e}`)}this.password=e.readString(128)??""}}class eV extends eF{protocolOperation;data=[];constructor(e){super(e),this.protocolOperation=97}parseMessage(e){for(super.parseMessage(e);e.remain>0;){let t=e.peek();if(160===t)break;this.data.push(e.readString("number"==typeof t?t:void 0)??"")}}}class eW extends eB{protocolOperation;dn;attribute;value;constructor(e){super(e),this.protocolOperation=110,this.attribute=e.attribute??"",this.value=e.value??"",this.dn=e.dn??""}writeMessage(e){e.writeString(this.dn),e.startSequence(),e.writeString(this.attribute),e.writeString(this.value),e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence(),this.attribute=(e.readString()??"").toLowerCase(),this.value=e.readString()??""}}var eK=((t=eK||{})[t.compareTrue=6]="compareTrue",t[t.compareFalse=5]="compareFalse",t[t.noSuchAttribute=22]="noSuchAttribute",t[t.noSuchObject=50]="noSuchObject",t);class eJ extends eF{protocolOperation;constructor(e){super(e),this.protocolOperation=111}}class eG extends eB{protocolOperation;dn;constructor(e){super(e),this.protocolOperation=74,this.dn=e.dn??""}writeMessage(e){for(let t of Buffer.from(this.dn))e.writeByte(t)}parseMessage(e){let{length:t}=e;this.dn=e.buffer.subarray(0,t).toString("utf8"),e.offset+=e.length}}class eX extends eF{protocolOperation;constructor(e){super(e),this.protocolOperation=107}}class eZ extends eB{protocolOperation;oid;value;constructor(e){super(e),this.protocolOperation=119,this.oid=e.oid??"",this.value=e.value??""}writeMessage(e){e.writeString(this.oid,128),Buffer.isBuffer(this.value)?e.writeBuffer(this.value,129):this.value&&e.writeString(this.value,129)}parseMessage(e){if(this.oid=e.readString(128)??"",129===e.peek())try{this.value=e.readString(129)??""}catch{this.value=e.readString(129,!0)??Buffer.alloc(0)}}}class eQ extends eF{protocolOperation;oid;value;constructor(e){super(e),this.protocolOperation=120,this.oid=e.oid,this.value=e.value}parseMessage(e){super.parseMessage(e),138===e.peek()&&(this.oid=e.readString(138)??""),139===e.peek()&&(this.value=e.readString(139)??void 0)}}class eY extends eB{protocolOperation;deleteOldRdn;dn;newRdn;newSuperior;constructor(e){super(e),this.protocolOperation=108,this.deleteOldRdn=!1!==e.deleteOldRdn,this.dn=e.dn??"",this.newRdn=e.newRdn??"",this.newSuperior=e.newSuperior??""}writeMessage(e){e.writeString(this.dn),e.writeString(this.newRdn),e.writeBoolean(this.deleteOldRdn),this.newSuperior&&e.writeString(this.newSuperior,128)}parseMessage(e){this.dn=e.readString()??"",this.newRdn=e.readString()??"",this.deleteOldRdn=e.readBoolean()??!1,128===e.peek()&&(this.newSuperior=e.readString(128)??"")}}class e1 extends eF{protocolOperation;constructor(e){super(e),this.protocolOperation=109}}class e0{operation;modification;constructor(e={modification:new e$}){this.operation=e.operation??"add",this.modification=e.modification}write(e){switch(e.startSequence(),this.operation){case"add":e.writeEnumeration(0);break;case"delete":e.writeEnumeration(1);break;case"replace":e.writeEnumeration(2);break;default:throw Error(`Unknown change operation: ${this.operation}`)}this.modification.write(e),e.endSequence()}parse(e){e.readSequence();let t=e.readEnumeration();switch(t){case 0:this.operation="add";break;case 1:this.operation="delete";break;case 2:this.operation="replace";break;case null:throw Error("Unknown change operation - <null> operation value");default:throw Error(`Unknown change operation: 0x${t.toString(16)}`)}this.modification=new e$,this.modification.parse(e)}}class e2 extends eB{protocolOperation;dn;changes;constructor(e){super(e),this.protocolOperation=102,this.dn=e.dn??"",this.changes=e.changes??[]}writeMessage(e){for(let t of(e.writeString(this.dn),e.startSequence(),this.changes))t.write(e);e.endSequence()}parseMessage(e){this.dn=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new e0;t.parse(e),this.changes.push(t)}}}class e6 extends eF{protocolOperation;constructor(e){super(e),this.protocolOperation=103}}class e8 extends eF{protocolOperation;name;attributes;constructor(e){super(e),this.protocolOperation=100,this.name=e.name??"",this.attributes=e.attributes??[]}parseMessage(e){this.name=e.readString()??"",e.readSequence();let t=e.offset+e.length;for(;e.offset<t;){let t=new e$;t.parse(e),this.attributes.push(t)}}toObject(e,t){let r={dn:this.name},s=new Set;for(let e of this.attributes){s.add(e.type.toLocaleLowerCase());let{values:i}=e;(t.includes(e.type)||i.some(e=>Buffer.isBuffer(e)))&&(i=e.parsedBuffers),i.length?1===i.length?r[e.type]=i[0]??[]:r[e.type]=i:r[e.type]=[]}for(let t of e)void 0!==r[t]||s.has(t.toLocaleLowerCase())||(r[t]=[]);return r}}class e4 extends eF{protocolOperation;uris;constructor(e){super(e),this.protocolOperation=115,this.uris=e.uris??[]}parseMessage(e){let t=e.offset+e.length;for(;e.offset<t;){let t=e.readString()??"";this.uris.push(t)}}}class e3{static parseString(e){if(!e)throw Error("Filter cannot be empty");e.startsWith("(")||(e=`(${e})`);let t=e3._parseString(e,0,e),r=e.length-1;if(t.end<r)throw Error(`Unbalanced parens in filter string: ${e}`);return t.filter}static parse(e){let t,r=e.readSequence();switch(r){case 160:t=new ek({filters:e3._parseSet(e)});break;case 168:(t=new eA).parse(e);break;case 163:(t=new eL).parse(e);break;case 169:(t=new eM).parse(e);break;case 165:(t=new eR).parse(e);break;case 166:(t=new eC).parse(e);break;case 162:t=new eI({filter:e3.parse(e)});break;case 161:t=new eT({filters:e3._parseSet(e)});break;case 135:(t=new e_).parse(e);break;case 164:(t=new eq).parse(e);break;default:throw Error(`Invalid search filter type: 0x${r??"<null>"}`)}return t}static _parseString(e,t,r){let s,i=t,{length:n}=e;if("("!==e[i])throw Error(`Missing paren: ${e}. Full string: ${r}`);switch(e[i+=1]){case"&":{i+=1;let t=[];do{let s=e3._parseString(e,i,r);t.push(s.filter),i=s.end+1}while(i<n&&")"!==e[i])s=new ek({filters:t});break}case"|":{i+=1;let t=[];do{let s=e3._parseString(e,i,r);t.push(s.filter),i=s.end+1}while(i<n&&")"!==e[i])s=new eT({filters:t});break}case"!":{let t=e3._parseString(e,i+1,r);s=new eI({filter:t.filter}),i=t.end+1;break}default:{let t=e.indexOf(")",i);if(-1===t)throw Error(`Unbalanced parens: ${e}. Full string: ${r}`);s=e3._parseExpressionFilterFromString(e.substring(i,t)),i=t}}return{end:i,filter:s}}static _parseExpressionFilterFromString(e){let t,r;if(e.startsWith(":"))t="",r=e;else{let s=/^[\w-]+/.exec(e);if(s?.length)[t]=s,r=e.slice(t.length);else throw Error(`Invalid attribute name: ${e}`)}if("=*"===r)return new e_({attribute:t});if(r.startsWith("=")){if((r=r.slice(1)).includes("*")){let e=e3._unescapeSubstring(r);return new eq({attribute:t,initial:e.initial,any:e.any,final:e.final})}return new eL({attribute:t,value:e3._unescapeHexValues(r)})}if(r.startsWith(">")&&"="===r[1])return new eR({attribute:t,value:e3._unescapeHexValues(r.slice(2))});if(r.startsWith("<")&&"="===r[1])return new eC({attribute:t,value:e3._unescapeHexValues(r.slice(2))});if(r.startsWith("~")&&"="===r[1])return new eA({attribute:t,value:e3._unescapeHexValues(r.slice(2))});if(r.startsWith(":"))return e3._parseExtensibleFilterFromString(t,r);throw Error(`Invalid expression: ${e}`)}static _parseExtensibleFilterFromString(e,t){let r,s=!1,i=t.split(":");if(i.length<=1)throw Error(`Invalid extensible filter: ${t}`);if(i.shift(),i[0]?.toLowerCase()==="dn"&&(s=!0,i.shift()),i.length&&!i[0]?.startsWith("=")&&(r=i.shift()),i.length&&!i[0]?.startsWith("="))throw Error(`Missing := in extensible filter: ${t}`);let n=i.join(":").slice(1);return new eM({matchType:e,dnAttributes:s,rule:r,value:e3._unescapeHexValues(n)})}static _unescapeHexValues(e){let t=0,r=e.length,s="";for(;t<r;){let r=e[t];switch(r){case"(":throw Error(`Illegal unescaped character: ${r} in value: ${e}`);case"\\":{let r=e.slice(t+1,t+3);if(null===/^[\dA-Fa-f]{2}$/.exec(r))throw Error(`Invalid escaped hex character: ${r} in value: ${e}`);s+=String.fromCharCode(Number.parseInt(r,16)),t+=3;break}default:r&&(s+=r),t+=1}}return s}static _unescapeSubstring(e){let t=e.split("*");if(t.length<2)throw Error(`Wildcard missing: ${e}`);return{initial:e3._unescapeHexValues(t.shift()??""),final:e3._unescapeHexValues(t.pop()??""),any:t.map(e=>e3._unescapeHexValues(e))}}static _parseSet(e){let t=[],r=e.offset+e.length;for(;e.offset<r;)t.push(e3.parse(e));return t}}class e5 extends eB{protocolOperation;baseDN;scope;derefAliases;sizeLimit;timeLimit;returnAttributeValues;filter;attributes;explicitBufferAttributes;constructor(e){super(e),this.protocolOperation=99,this.baseDN=e.baseDN??"",this.scope=e.scope??"sub",this.derefAliases=e.derefAliases??"never",this.sizeLimit=e.sizeLimit??0,this.timeLimit=e.timeLimit??10,this.returnAttributeValues=!1!==e.returnAttributeValues,this.filter=e.filter,this.attributes=e.attributes??[],this.explicitBufferAttributes=e.explicitBufferAttributes??[]}writeMessage(e){switch(e.writeString(this.baseDN),this.scope){case"base":e.writeEnumeration(0);break;case"one":e.writeEnumeration(1);break;case"sub":e.writeEnumeration(2);break;case"children":case"subordinates":e.writeEnumeration(3);break;default:throw Error(`Invalid search scope: ${this.scope}`)}switch(this.derefAliases){case"never":e.writeEnumeration(0);break;case"search":e.writeEnumeration(1);break;case"find":e.writeEnumeration(2);break;case"always":e.writeEnumeration(3);break;default:throw Error(`Invalid deref alias: ${this.derefAliases}`)}for(let t of(e.writeInt(this.sizeLimit),e.writeInt(this.timeLimit),e.writeBoolean(!this.returnAttributeValues),this.filter.write(e),e.startSequence(),this.attributes))e.writeString(t);e.endSequence()}parseMessage(e){this.baseDN=e.readString()??"";let t=e.readEnumeration();switch(t){case 0:this.scope="base";break;case 1:this.scope="one";break;case 2:this.scope="sub";break;case 3:this.scope="children";break;default:throw Error(`Invalid search scope: ${t??"<null>"}`)}let r=e.readEnumeration();switch(t){case 0:this.derefAliases="never";break;case 1:this.derefAliases="search";break;case 2:this.derefAliases="find";break;case 3:this.derefAliases="always";break;default:throw Error(`Invalid deref alias: ${r??"<null>"}`)}if(this.sizeLimit=e.readInt()??0,this.timeLimit=e.readInt()??0,this.returnAttributeValues=!e.readBoolean(),this.filter=e3.parse(e),48===e.peek()){e.readSequence();let t=e.offset+e.length;for(;e.offset<t;)this.attributes.push((e.readString()??"").toLowerCase())}}}class e9 extends eF{protocolOperation;searchEntries;searchReferences;constructor(e){super(e),this.protocolOperation=101,this.searchEntries=e.searchEntries??[],this.searchReferences=e.searchReferences??[]}}class e7 extends eB{protocolOperation;constructor(e){super(e),this.protocolOperation=66}}class te extends L.EventEmitter{buffer;read(e,t){let r,s,i;this.buffer?this.buffer=Buffer.concat([this.buffer,e]):this.buffer=e;let n=new R(this.buffer),a=null;try{a=n.readSequence()}catch(e){this.emit("error",e)}if(a&&!(n.remain<n.length)){n.remain>n.length&&(r=this.buffer.subarray(n.offset+n.length),n.setBufferSize(n.offset+n.length)),delete this.buffer;try{if(s=n.readInt(),null==s)throw Error("Unable to read message id");if(i=n.readSequence(),null==i)throw Error(`Unable to read protocol operation sequence for message: ${s}`);let e=t.get(`${s}`),r=this._getMessageFromProtocolOperation(s,i,n,e?.message);this.emit("message",r)}catch(e){if(s){e.messageDetails={messageId:s},i&&(e.messageDetails.protocolOperation=i),this.emit("error",e);return}this.emit("error",e);return}r&&this.read(r,t)}}_getMessageFromProtocolOperation(e,t,r,s){let i;switch(t){case 97:i=new eV({messageId:e});break;case 105:i=new eU({messageId:e});break;case 111:i=new eJ({messageId:e});break;case 107:i=new eX({messageId:e});break;case 120:i=new eQ({messageId:e});break;case 109:i=new e1({messageId:e});break;case 103:i=new e6({messageId:e});break;case 101:i=new e9({messageId:e});break;case 100:i=new e8({messageId:e});break;case 115:i=new e4({messageId:e});break;default:{let r=new B(`Protocol Operation not supported: 0x${t.toString(16)}`);throw r.messageDetails={messageId:e,protocolOperation:t},r}}return i.parse(r,s?.controls??[]),i}}class tt{static parse(e){if(!e)return new ec;switch(e.status){case 1:return new eu(e.errorMessage);case 2:return new eh(e.errorMessage);case 3:return new ew(e.errorMessage);case 4:return new ef(e.errorMessage);case 7:return new z(e.errorMessage);case 8:return new eg(e.errorMessage);case 11:return new j(e.errorMessage);case 12:return new ey(e.errorMessage);case 13:return new V(e.errorMessage);case 14:return new ep(e);case 16:return new ei(e.errorMessage);case 17:return new ev(e.errorMessage);case 18:return new J(e.errorMessage);case 19:return new W(e.errorMessage);case 20:return new eb(e.errorMessage);case 21:return new Q(e.errorMessage);case 32:return new en(e.errorMessage);case 33:return new F(e.errorMessage);case 34:return new Z(e.errorMessage);case 35:return new Y(e.errorMessage);case 36:return new N(e.errorMessage);case 48:return new K(e.errorMessage);case 49:return new X(e.errorMessage);case 50:return new G(e.errorMessage);case 51:return new H(e.errorMessage);case 52:return new eS(e.errorMessage);case 53:return new ex(e.errorMessage);case 54:return new ee(e.errorMessage);case 64:return new er(e.errorMessage);case 65:return new el(e.errorMessage);case 66:return new ea(e.errorMessage);case 67:return new eo(e.errorMessage);case 68:return new U(e.errorMessage);case 69:return new es(e.errorMessage);case 70:return new ed(e.errorMessage);case 71:return new $(e.errorMessage);case 95:return new et(e.errorMessage);case 112:return new em(e.errorMessage);case 248:return new ec(e.errorMessage);default:return new eO(e.status,e.errorMessage)}}}let tr=0x80000000-1,ts=(0,x.debuglog)("ldapts");Symbol.asyncDispose??=Symbol("Symbol.asyncDispose");class ti{clientOptions;messageId=1;host;port;secure;connected=!1;socket;connectTimer;messageParser=new te;messageDetailsByMessageId=new Map;constructor(e){let t;this.clientOptions=e,this.clientOptions.timeout??=0,this.clientOptions.connectTimeout??=0,this.clientOptions.strictDN=!1!==this.clientOptions.strictDN;try{t=new URL(e.url)}catch{throw Error(`${e.url} is an invalid LDAP URL (protocol)`)}const r=t.protocol.replace(/:$/,"");if("ldap"!==r&&"ldaps"!==r)throw Error(`${e.url} is an invalid LDAP URL (protocol)`);const s="ldaps"===r,i=!!this.clientOptions.tlsOptions&&Object.values(this.clientOptions.tlsOptions).some(e=>void 0!==e);this.secure=s||i;let n=t.hostname;n.startsWith("[")&&n.endsWith("]")&&(n=n.slice(1,-1)),this.host=n||"localhost",t.port?this.port=Number(t.port):s?this.port=636:this.port=389,this.messageParser.on("error",e=>{if(e.messageDetails?.messageId){let t=this.messageDetailsByMessageId.get(e.messageDetails.messageId.toString());if(t){this.messageDetailsByMessageId.delete(e.messageDetails.messageId.toString()),t.reject(e);return}}e.stack&&ts(e.stack)}),this.messageParser.on("message",this._handleSendResponse.bind(this))}get isConnected(){return!!this.socket&&this.connected}async startTLS(e={},t){this.isConnected||await this._connect(),await this.exop("1.3.6.1.4.1.1466.20037",void 0,t);let r=this.socket;r&&(r.removeListener("data",this.socketDataHandler),e.socket=r),this.socket=await new Promise((t,s)=>{let i=A.connect(e);i.once("secureConnect",()=>{i.removeAllListeners("error"),i.on("data",this.socketDataHandler),i.on("error",()=>{r&&r.destroy()}),t(i)}),i.once("error",e=>{i.removeAllListeners(),s(e)})}),r&&(this.socket.id=r.id)}async bind(e,t,r){if(r&&!Array.isArray(r)&&(r=[r]),"string"==typeof e&&ez.includes(e))return void await this.bindSASL(e,t,r);let s=new eH({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),password:t,controls:r});await this._sendBind(s)}async bindSASL(e,t,r){r&&!Array.isArray(r)&&(r=[r]);let s=new eH({messageId:this._nextMessageId(),mechanism:e,password:t,controls:r});await this._sendBind(s)}async add(e,t,r){let s;if(this.isConnected||await this._connect(),r&&!Array.isArray(r)&&(r=[r]),Array.isArray(t))s=t;else for(let[e,r]of(s=[],Object.entries(t))){let t;t=Array.isArray(r)?r:null==r?[]:[r],s.push(new e$({type:e,values:t}))}let i=new eN({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),attributes:s,controls:r}),n=await this._send(i);if(n?.status!==0)throw tt.parse(n)}async compare(e,t,r,s){this.isConnected||await this._connect(),s&&!Array.isArray(s)&&(s=[s]);let i=new eW({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),attribute:t,value:r,controls:s}),n=await this._send(i);switch(n?.status){case eK.compareTrue:return!0;case eK.compareFalse:return!1;default:throw tt.parse(n)}}async del(e,t){this.isConnected||await this._connect(),t&&!Array.isArray(t)&&(t=[t]);let r=new eG({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),controls:t}),s=await this._send(r);if(s?.status!==0)throw tt.parse(s)}async exop(e,t,r){this.isConnected||await this._connect(),r&&!Array.isArray(r)&&(r=[r]);let s=new eZ({messageId:this._nextMessageId(),oid:e,value:t,controls:r}),i=await this._send(s);if(i?.status!==0)throw tt.parse(i);return{oid:i.oid,value:i.value}}async modify(e,t,r){this.isConnected||await this._connect(),Array.isArray(t)||(t=[t]),r&&!Array.isArray(r)&&(r=[r]);let s=new e2({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),changes:t,controls:r}),i=await this._send(s);if(i?.status!==0)throw tt.parse(i)}async modifyDN(e,t,r){let s;if(this.isConnected||await this._connect(),r&&!Array.isArray(r)&&(r=[r]),"string"==typeof t&&/[^\\],/.test(t)){let e=t.search(/[^\\],/);s=t.slice(e+2),t=t.slice(0,e+1)}let i=new eY({messageId:this._nextMessageId(),dn:"string"==typeof e?e:e.toString(),deleteOldRdn:!0,newRdn:"string"==typeof t?t:t.toString(),newSuperior:s,controls:r}),n=await this._send(i);if(n?.status!==0)throw tt.parse(n)}async search(e,t={},r){let s,i;if(this.isConnected||await this._connect(),r){for(let e of r=Array.isArray(r)?r.slice(0):[r])if(e instanceof _)throw Error("Should not specify PagedResultsControl")}else r=[];let n=100;"object"==typeof t.paged&&t.paged.pageSize?n=t.paged.pageSize:t.sizeLimit&&t.sizeLimit>1&&(n=t.sizeLimit-1);let a=!!t.paged;a&&(s=new _({value:{size:n}}),r.push(s)),i=t.filter?"string"==typeof t.filter?e3.parseString(t.filter):t.filter:new e_({attribute:"objectclass"});let o=new e5({messageId:-1,baseDN:"string"==typeof e?e:e.toString(),scope:t.scope,filter:i,attributes:t.attributes,explicitBufferAttributes:t.explicitBufferAttributes,returnAttributeValues:t.returnAttributeValues,sizeLimit:t.sizeLimit,timeLimit:t.timeLimit,controls:r}),c={searchEntries:[],searchReferences:[]};return await this._sendSearch(o,c,a,n,s),c}async *searchPaginated(e,t={},r){let s,i;if(this.isConnected||await this._connect(),r){for(let e of r=Array.isArray(r)?r.slice(0):[r])if(e instanceof _)throw Error("Should not specify PagedResultsControl")}else r=[];let n=100;"object"==typeof t.paged&&t.paged.pageSize?n=t.paged.pageSize:t.sizeLimit&&t.sizeLimit>1&&(n=t.sizeLimit-1),s=new _({value:{size:n}}),r.push(s),i=t.filter?"string"==typeof t.filter?e3.parseString(t.filter):t.filter:new e_({attribute:"objectclass"});let a=new e5({messageId:-1,baseDN:"string"==typeof e?e:e.toString(),scope:t.scope,filter:i,attributes:t.attributes,explicitBufferAttributes:t.explicitBufferAttributes,returnAttributeValues:t.returnAttributeValues,sizeLimit:t.sizeLimit,timeLimit:t.timeLimit,controls:r});do{let e={searchEntries:[],searchReferences:[]};s=await this._sendSearch(a,e,!0,n,s,!1),yield e}while(s)}async unbind(){try{if(!this.connected||!this.socket)return;let e=new e7({messageId:this._nextMessageId()});await this._send(e)}finally{this._destroySocket(this.socket)}}[Symbol.asyncDispose](){return this.unbind()}async _sendBind(e){this.isConnected||await this._connect();let t=await this._send(e);if(t?.status!==0)throw tt.parse(t)}async _sendSearch(e,t,r,s,i,n=!0){e.messageId=this._nextMessageId();let a=await this._send(e);if(a?.status!==0&&!(a?.status===4&&e.sizeLimit))throw tt.parse(a);for(let r of a.searchEntries)t.searchEntries.push(r.toObject(e.attributes,e.explicitBufferAttributes));for(let e of a.searchReferences)t.searchReferences.push(...e.uris);if(r&&(a.searchEntries.length||a.searchReferences.length)&&i){let o;for(let e of a.controls??[])if(e instanceof _){o=e;break}if(o?.value?.cookie?.length){if(i.value=i.value??{size:s},i.value.cookie=o.value.cookie,!n)return i;await this._sendSearch(e,t,r,s,i,!0)}}}socketDataHandler=e=>{this.messageParser&&this.messageParser.read(e,this.messageDetailsByMessageId)};_nextMessageId(){return this.messageId+=1,this.messageId>=tr&&(this.messageId=1),this.messageId}_connect(){if(!this.isConnected)return new Promise((e,t)=>{this.secure?(this.socket=A.connect(this.port,this.host,this.clientOptions.tlsOptions),this.socket.id=E.randomUUID(),this.socket.once("secureConnect",()=>{this._onConnect(e)})):(this.socket=k.connect(this.port,this.host),this.socket.id=E.randomUUID(),this.socket.once("connect",()=>{this._onConnect(e)})),this.socket.once("error",e=>{this._destroySocket(this.socket),t(e)}),this.clientOptions.connectTimeout&&(this.connectTimer=setTimeout(()=>{this._destroySocket(this.socket),t(Error("Connection timeout"))},this.clientOptions.connectTimeout))})}_onConnect(e){this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0),this.socket&&(this.socket.removeAllListeners("error"),this.socket.removeAllListeners("connect"),this.socket.removeAllListeners("secureConnect")),this.connected=!0;let t=e=>{for(let[t,r]of this.messageDetailsByMessageId.entries())r.message instanceof e7?r.resolve():r.reject(Error(`Socket error. Message type: ${r.message.constructor.name} (0x${r.message.protocolOperation.toString(16)})
${e.message||(e.stack??"Unknown socket error")}`)),this.messageDetailsByMessageId.delete(t);this.socket&&this.socket.destroy()};function r(){this&&this.end()}function s(){this&&this.end()}let i=this;this.socket&&(this.socket.on("error",t),this.socket.on("close",function e(){for(let[n,a]of(this&&(this.removeListener("error",t),this.removeListener("close",e),this.removeListener("data",i.socketDataHandler),this.removeListener("end",r),this.removeListener("timeout",s)),this===i.socket&&(i.connected=!1,delete i.socket,i.connectTimer&&(clearTimeout(i.connectTimer),i.connectTimer=void 0)),i.messageDetailsByMessageId.entries()))a.socket.id===this.id&&(a.message instanceof e7?a.resolve():a.reject(Error(`Connection closed before message response was received. Message type: ${a.message.constructor.name} (0x${a.message.protocolOperation.toString(16)})`)),i.messageDetailsByMessageId.delete(n))}),this.socket.on("data",this.socketDataHandler),this.socket.on("end",r),this.socket.on("timeout",s)),e()}_destroySocket(e){e&&(this.connectTimer&&(clearTimeout(this.connectTimer),this.connectTimer=void 0),e.removeAllListeners("error"),e.on("error",()=>{}),e.end(),e.destroy(),e===this.socket&&(this.connected=!1,this.socket=void 0))}_send(e){if(!this.connected||!this.socket)throw Error("Socket connection not established");let t=e.write(),r=this.clientOptions.timeout?setTimeout(()=>{let t=this.messageDetailsByMessageId.get(e.messageId.toString());t&&(this._destroySocket(t.socket),i(Error(`${e.constructor.name}: Operation timed out`)))},this.clientOptions.timeout):null,s=()=>{},i=()=>{},n=new Promise((e,t)=>{s=e,i=t}).finally(()=>{r&&clearTimeout(r)});return this.messageDetailsByMessageId.set(e.messageId.toString(),{message:e,resolve:s,reject:i,timeoutTimer:r,socket:this.socket}),e.password?ts(`Sending message: ${JSON.stringify({...e,password:"__redacted__"})}`):ts(`Sending message: ${JSON.stringify(e)}`),this.socket.write(t,()=>{e instanceof eD?(ts(`Abandoned message: ${e.messageId}`),this.messageDetailsByMessageId.delete(e.messageId.toString()),s()):e instanceof e7?(ts("Unbind success. Ending socket"),this.socket&&this._destroySocket(this.socket)):ts("Message sent successfully.")}),n}_handleSendResponse(e){let t=this.messageDetailsByMessageId.get(e.messageId.toString());t?e instanceof e8?(t.searchEntries=t.searchEntries??[],t.searchEntries.push(e)):e instanceof e4?(t.searchReferences=t.searchReferences??[],t.searchReferences.push(e)):(e instanceof e9&&(t.searchEntries&&e.searchEntries.push(...t.searchEntries),t.searchReferences&&e.searchReferences.push(...t.searchReferences)),this.messageDetailsByMessageId.delete(e.messageId.toString()),t.resolve(e)):ts(`Unable to find details related to message response: ${JSON.stringify(e)}`)}}function tn(){let e=process.env.LDAP_URL?.trim(),t=process.env.LDAP_BASE_DN?.trim();return e&&t?{url:e,baseDn:t,userFilter:process.env.LDAP_USER_FILTER?.trim()||"(mail={{email}})",bindDn:process.env.LDAP_BIND_DN?.trim()||void 0,bindPassword:process.env.LDAP_BIND_PASSWORD?.trim()||void 0,timeoutMs:Number(process.env.LDAP_TIMEOUT_MS??5e3)}:null}async function ta(e,t){let r=tn();if(!r)return{ok:!1,error:"LDAP no est√° configurado."};let s=e.trim().toLowerCase(),i=new ti({url:r.url,timeout:r.timeoutMs,connectTimeout:r.timeoutMs});try{var n;if(!r.bindDn||!r.bindPassword)return await i.bind(s,t),{ok:!0,user:{email:s,source:"ldap"}};await i.bind(r.bindDn,r.bindPassword);let e=(n=r.userFilter,n.replace(/\{\{\s*email\s*\}\}/gi,s)),a=(await i.search(r.baseDn,{scope:"sub",filter:e,attributes:["dn","mail"],sizeLimit:1})).searchEntries[0];if(!a||"string"!=typeof a.dn)return{ok:!1,error:"Usuario no encontrado en LDAP."};let o=a.dn;await i.unbind();let c=new ti({url:r.url,timeout:r.timeoutMs,connectTimeout:r.timeoutMs});try{await c.bind(o,t);let e={email:"string"==typeof a.mail&&a.mail.trim()?a.mail.toLowerCase():s,source:"ldap"};return{ok:!0,user:e}}finally{await c.unbind()}}catch{return{ok:!1,error:"Credenciales LDAP inv√°lidas o servidor no disponible."}}finally{try{await i.unbind()}catch{}}}var to=e.i(91180),tc=e.i(60187);async function tl(e){try{if(!process.env.AUTH_JWT_SECRET?.trim())return y.NextResponse.json({error:"Falta AUTH_JWT_SECRET en .env.local para crear la sesi√≥n."},{status:500});let t=await e.json(),r=t.email?.trim().toLowerCase()??"",s=t.password?.trim()??"";if(!r||!s)return y.NextResponse.json({error:"Debes ingresar correo y contrase√±a."},{status:400});let i=await v(r,s);if(i.ok&&i.user){let e=await (0,to.createSessionToken)(i.user),t=y.NextResponse.json({ok:!0,source:"local",user:i.user});return(0,tc.setSessionCookie)(t,e),t}if(null!==tn()){let e=await ta(r,s);if(e.ok&&e.user){let t=await (0,to.createSessionToken)(e.user),r=y.NextResponse.json({ok:!0,source:"ldap",user:e.user});return(0,tc.setSessionCookie)(r,t),r}}return y.NextResponse.json({error:"Credenciales inv√°lidas."},{status:401})}catch(t){let e=t instanceof Error&&t.message?t.message:"No se pudo procesar el login.";return y.NextResponse.json({error:e},{status:500})}}e.s(["POST",()=>tl],11615);var tu=e.i(11615);let th=new r.AppRouteRouteModule({definition:{kind:s.RouteKind.APP_ROUTE,page:"/api/auth/login/route",pathname:"/api/auth/login",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/src/app/api/auth/login/route.ts",nextConfigOutput:"standalone",userland:tu}),{workAsyncStorage:td,workUnitAsyncStorage:tp,serverHooks:tf}=th;function tg(){return(0,i.patchFetch)({workAsyncStorage:td,workUnitAsyncStorage:tp})}async function tw(e,t,r){th.isDev&&(0,n.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let i="/api/auth/login/route";i=i.replace(/\/index$/,"")||"/";let y=await th.prepare(e,t,{srcPage:i,multiZoneDraftMode:!1});if(!y)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:S,params:v,nextConfig:O,parsedUrl:x,isDraftMode:E,prerenderManifest:k,routerServerContext:A,isOnDemandRevalidate:L,revalidateOnlyGenerated:M,resolvedPathname:R,clientReferenceManifest:C,serverActionsManifest:I}=y,T=(0,c.normalizeAppPath)(i),_=!!(k.dynamicRoutes[T]||k.routes[R]),q=async()=>((null==A?void 0:A.render404)?await A.render404(e,t,x,!1):t.end("This page could not be found"),null);if(_&&!E){let e=!!k.routes[R],t=k.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(O.experimental.adapterPath)return await q();throw new m.NoFallbackError}}let P=null;!_||th.isDev||E||(P="/index"===(P=R)?"/":P);let B=!0===th.isDev||!_,D=_&&!B;I&&C&&(0,o.setManifestsSingleton)({page:i,clientReferenceManifest:C,serverActionsManifest:I});let j=e.method||"GET",$=(0,a.getTracer)(),N=$.getActiveScopeSpan(),F={params:v,prerenderManifest:k,renderOpts:{experimental:{authInterrupts:!!O.experimental.authInterrupts},cacheComponents:!!O.cacheComponents,supportsDynamicResponse:B,incrementalCache:(0,n.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:O.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,s,i)=>th.onRequestError(e,t,s,i,A)},sharedContext:{buildId:S}},U=new l.NodeNextRequest(e),z=new l.NodeNextResponse(t),H=u.NextRequestAdapter.fromNodeNextRequest(U,(0,u.signalFromNodeResponse)(t));try{let o=async e=>th.handle(H,F).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=$.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==h.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let s=r.get("next.route");if(s){let t=`${j} ${s}`;e.setAttributes({"next.route":s,"http.route":s,"next.span_name":t}),e.updateName(t)}else e.updateName(`${j} ${i}`)}),c=!!(0,n.getRequestMeta)(e,"minimalMode"),l=async n=>{var a,l;let u=async({previousCacheEntry:s})=>{try{if(!c&&L&&M&&!s)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let i=await o(n);e.fetchMetrics=F.renderOpts.fetchMetrics;let a=F.renderOpts.pendingWaitUntil;a&&r.waitUntil&&(r.waitUntil(a),a=void 0);let l=F.renderOpts.collectedTags;if(!_)return await (0,p.sendResponse)(U,z,i,F.renderOpts.pendingWaitUntil),null;{let e=await i.blob(),t=(0,f.toNodeOutgoingHttpHeaders)(i.headers);l&&(t[w.NEXT_CACHE_TAGS_HEADER]=l),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==F.renderOpts.collectedRevalidate&&!(F.renderOpts.collectedRevalidate>=w.INFINITE_CACHE)&&F.renderOpts.collectedRevalidate,s=void 0===F.renderOpts.collectedExpire||F.renderOpts.collectedExpire>=w.INFINITE_CACHE?void 0:F.renderOpts.collectedExpire;return{value:{kind:b.CachedRouteKind.APP_ROUTE,status:i.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:s}}}}catch(t){throw(null==s?void 0:s.isStale)&&await th.onRequestError(e,t,{routerKind:"App Router",routePath:i,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:L})},!1,A),t}},h=await th.handleResponse({req:e,nextConfig:O,cacheKey:P,routeKind:s.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:k,isRoutePPREnabled:!1,isOnDemandRevalidate:L,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:c});if(!_)return null;if((null==h||null==(a=h.value)?void 0:a.kind)!==b.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==h||null==(l=h.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});c||t.setHeader("x-nextjs-cache",L?"REVALIDATED":h.isMiss?"MISS":h.isStale?"STALE":"HIT"),E&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,f.fromNodeOutgoingHttpHeaders)(h.value.headers);return c&&_||m.delete(w.NEXT_CACHE_TAGS_HEADER),!h.cacheControl||t.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,g.getCacheControlHeader)(h.cacheControl)),await (0,p.sendResponse)(U,z,new Response(h.value.body,{headers:m,status:h.value.status||200})),null};N?await l(N):await $.withPropagatedContext(e.headers,()=>$.trace(h.BaseServerSpan.handleRequest,{spanName:`${j} ${i}`,kind:a.SpanKind.SERVER,attributes:{"http.method":j,"http.target":e.url}},l))}catch(t){if(t instanceof m.NoFallbackError||await th.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,d.getRevalidateReason)({isStaticGeneration:D,isOnDemandRevalidate:L})},!1,A),_)throw t;return await (0,p.sendResponse)(U,z,new Response(null,{status:500})),null}}e.s(["handler",()=>tw,"patchFetch",()=>tg,"routeModule",()=>th,"serverHooks",()=>tf,"workAsyncStorage",()=>td,"workUnitAsyncStorage",()=>tp],30450)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__92f113da._.js.map